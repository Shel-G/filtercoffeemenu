<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>标签看板 + 风味轮（联动筛选）</title>
<style>
  :root{--bg:#0b0c10;--card:#12151b;--muted:#95a0ad;--fg:#e8edf2;--chip:#1c222c;--chip-a:#2b6cb0;--border:#232a33;--accent:#6aa9ff}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  .container{max-width:1200px;margin:36px auto;padding:0 16px}
  h1{margin:0 0 6px}
  .sub{color:var(--muted);margin-bottom:18px}
  .row{display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:1060px){.row{grid-template-columns:380px 1fr}}
  .panel{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
  .section{margin-bottom:10px}
  .section h3{margin:0 0 8px;font-size:13px;color:#cdd6df;text-transform:uppercase;letter-spacing:.04em}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid #2a3140;color:#d7deea;cursor:pointer;user-select:none;transition:.15s}
  .chip:hover{border-color:#374359}
  .chip.active{background:var(--chip-a);border-color:#2b6cb0}
  select{background:#0f1320;color:#dfe7f2;border:1px solid #263145;border-radius:10px;padding:8px 10px;min-width:170px}
  button{background:#162034;color:#dfe7f2;border:1px solid #24324a;border-radius:10px;padding:8px 10px;cursor:pointer}
  button:hover{border-color:#3b82f6}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:12px}
  .badges{display:flex;gap:6px;flex-wrap:wrap}
  .badge{font-size:12px;padding:3px 8px;border:1px solid #2b3545;border-radius:999px;color:#cdd6df;background:#11161f}
  .muted{color:var(--muted)}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:720px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media(min-width:1080px){.grid{grid-template-columns:repeat(3,1fr)}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:8px}
  .title{font-weight:700}
  .meta{font-size:13px;color:#aeb6bf}
  .price{font-weight:700}
  .wheel-wrap{display:flex;align-items:center;justify-content:center}
  .legend{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;justify-content:center}
  .leg{display:flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid #2a3140;border-radius:12px;background:#0f1520;font-size:12px}
  .sw{width:10px;height:10px;border-radius:2px;display:inline-block}
</style>
</head>
<body>
  <div class="container">
    <h1>标签看板 + 风味轮（联动筛选）</h1>
    <div class="sub">全局仅支持 <b>价格排序</b>；左侧为标签看板（二级筛选），右侧含风味轮，二者与商品卡联动。</div>

    <div class="panel toolbar">
      <div class="muted">排序：</div>
      <select id="sortSelect">
        <option value="">默认排序</option>
        <option value="price-asc">价格 ↑</option>
        <option value="price-desc">价格 ↓</option>
      </select>
      <div style="flex:1"></div>
      <button id="resetBtn">重置筛选</button>
    </div>

    <div class="row">
      <!-- 左侧：标签看板（Level-2） -->
      <aside class="panel">
        <div class="section">
          <h3>食材品种</h3>
          <div id="ingChips" class="chips"></div>
        </div>
        <div class="section">
          <h3>处理方式</h3>
          <div id="procChips" class="chips"></div>
        </div>
        <div class="section">
          <h3>产地来源（国家 / 产区 / 庄园）</h3>
          <div class="chips" id="orgChips"></div>
          <div class="chips" id="regChips" style="margin-top:6px"></div>
          <div class="chips" id="estChips" style="margin-top:6px"></div>
        </div>
        <div class="section">
          <h3>烘焙度</h3>
          <div id="rstChips" class="chips"></div>
        </div>
        <div class="section">
          <h3>特色信息</h3>
          <div id="spcChips" class="chips"></div>
        </div>
      </aside>

      <!-- 右侧：风味轮 + 结果区 -->
      <main>
        <div class="panel" style="margin-bottom:12px">
          <div id="activeFilters" class="badges"></div>
          <div class="muted" id="stats"></div>
        </div>

        <div class="panel" style="margin-bottom:12px">
          <div class="section">
            <h3>风味轮（点击/再次点击 = 选择/取消该风味家族）</h3>
            <div class="wheel-wrap">
              <svg id="flavorWheel" width="360" height="360" viewBox="0 0 360 360" role="img" aria-label="风味轮"></svg>
            </div>
            <div class="legend" id="wheelLegend"></div>
          </div>
        </div>

        <div id="grid" class="grid"></div>
      </main>
    </div>
  </div>

<script>
// ======== 数据（示例：咖啡类） ========
const items = [
  { name_zh:"Finca SantaMaria 圣塔玛利亚庄园 Ghands", ingredient_type:["瑰夏"], processing_method:["日晒","厌氧发酵"], flavor_profile:["橙花","甜橙","杏桃","荔枝","莓果","混合水果糖"], category:"咖啡", price_unit:{ price:"168-188", unit:"份", currency:"¥" }, special_info:["独家批次","24年BOP瑰夏日晒组第8名"], origin:"巴拿马", region:"奇里基", estate:"圣塔玛利亚庄园", roast_level:"中度烘焙" },
  { name_zh:"Elida Estate 艾力达庄园 VUELTA地块 EGN DRD 瑰夏暗房日晒", ingredient_type:["瑰夏"], processing_method:["日晒","暗房日晒"], flavor_profile:["玉兰花","橙汁","水蜜桃","葡萄","荔枝","蜂蜜"], category:"咖啡", price_unit:{ price:"158-168", unit:"份", currency:"¥" }, special_info:["24年BOP瑰夏日晒组冠军","24年BOP竞拍标王"], origin:"巴拿马", region:"波奎特", estate:"艾力达庄园", roast_level:"中度烘焙" },
  { name_zh:"Altieri 阿尔铁里庄园 Accio 甄选批次 ALESSA地块 DFC绿顶瑰夏", ingredient_type:["瑰夏"], processing_method:["日晒","干燥冷发酵"], flavor_profile:["玫瑰花","菠萝","芒果","阳光玫瑰","白葡萄","香草奶油","白葡萄酒尾韵"], category:"咖啡", price_unit:{ price:"128-148", unit:"份", currency:"¥" }, special_info:["24年BOP瑰夏日晒组季军"], origin:"巴拿马", region:"波奎特", estate:"阿尔铁里庄园", roast_level:"中度烘焙" },
  { name_zh:"Elida Estate 艾力达庄园 25新产季 Aguacate地块 EGW DRD 瑰夏水洗暗房干燥", ingredient_type:["瑰夏"], processing_method:["水洗","暗房水洗"], flavor_profile:["姜花","咖啡花","茉莉花","甜柚","佛手柑","柠檬糖"], category:"咖啡", price_unit:{ price:"158-168", unit:"份", currency:"¥" }, special_info:["24年BOP瑰夏日晒组冠军","24年BOP竞拍标王"], origin:"巴拿马", region:"波奎特", estate:"艾力达庄园", roast_level:"中度烘焙" },
  { name_zh:"Elida Estate 艾力达庄园 25新产季 VUELTA地块 EGW 水洗绿顶瑰夏", ingredient_type:["瑰夏"], processing_method:["水洗"], flavor_profile:["玉兰花","花香","柑橘苏打","佛手柑","蔗糖","酸质明亮"], category:"咖啡", price_unit:{ price:"158-168", unit:"份", currency:"¥" }, special_info:["24年BOP瑰夏日晒组冠军","24年BOP竞拍标王"], origin:"巴拿马", region:"波奎特", estate:"艾力达庄园", roast_level:"中度烘焙" },
  { name_zh:"Finca Deborah 黛博拉庄园 25年新产季鲜活 Vivid 二氧化碳日晒发酵水洗干燥瑰夏", ingredient_type:["瑰夏"], processing_method:["日晒","二氧化碳浸渍","发酵","水洗","干燥"], flavor_profile:["黄色花香","蜂迦","气泡酒","水蜜桃","香草"], category:"咖啡", price_unit:{ price:"168-188", unit:"份", currency:"¥" }, special_info:["24年WBrC冠军","亚军","季军用豆庄园"], origin:"巴拿马", region:"沃肯", estate:"黛博拉庄园", roast_level:"中度烘焙" },
  { name_zh:"Finca Deborah 黛博拉庄园 25年新产季回声 Echo二氧化碳带果皮浸渍发酵水洗瑰夏", ingredient_type:["瑰夏"], processing_method:["二氧化碳带果皮浸渍发酵","水洗"], flavor_profile:["姜花","花蜜","血橙","树莓","甜橙","草莓酱"], category:"咖啡", price_unit:{ price:"168-188", unit:"份", currency:"¥" }, special_info:["24年WBrC冠军","亚军","季军用豆庄园"], origin:"巴拿马", region:"沃肯", estate:"黛博拉庄园", roast_level:"中度烘焙" },
  { name_zh:"Flying Pumas 飞豹庄园 日晒瑰夏 FPNLG24003批次", ingredient_type:["瑰夏"], processing_method:["日晒"], flavor_profile:["热带水果","芒果","百香果","甜橙","蜂糖李"], category:"咖啡", price_unit:{ price:"178-198", unit:"份", currency:"¥" }, special_info:[], origin:"巴拿马", region:"沃肯", estate:"飞豹庄园", roast_level:"中度烘焙" },
  { name_zh:"Flying Pumas 飞豹庄园 动态发酵水洗瑰夏 Ghands独家 JAGUARUNDI 1.0微批次", ingredient_type:["瑰夏"], processing_method:["动态发酵","水洗"], flavor_profile:["洋甘菊","佛手柑","蜜橘","桃子"], category:"咖啡", price_unit:{ price:"178-198", unit:"份", currency:"¥" }, special_info:["独家","微批次"], origin:"巴拿马", region:"沃肯", estate:"飞豹庄园", roast_level:"中度烘焙" },
  { name_zh:"Flying Pumas 飞豹庄园 开放发酵水洗瑰夏 FPNLG24010批次", ingredient_type:["瑰夏"], processing_method:["开放发酵","水洗"], flavor_profile:["龙眼花","花香","佛手柑","甜橙","桃子","龙眼","蜜橘"], category:"咖啡", price_unit:{ price:"178-198", unit:"份", currency:"¥" }, special_info:[], origin:"巴拿马", region:"沃肯", estate:"飞豹庄园", roast_level:"中度烘焙" },
  { name_zh:"Hacienda La Esmeralda 翡翠庄园 Canas Verdes地块 Trapiche批次 红标日晒瑰夏", ingredient_type:["瑰夏"], processing_method:["日晒"], flavor_profile:["玉兰花","柠檬草","柑橘","甜橙","蔓越莓","百香果"], category:"咖啡", price_unit:{ price:"178-198", unit:"份", currency:"¥" }, special_info:["红标日晒","24年BOP瑰夏日晒组第10名"], origin:"巴拿马", region:"波奎特", estate:"翡翠庄园", roast_level:"中度烘焙" },
  { name_zh:"Finca Los Cenizo圣妮佐庄园 Accio独家甄选批次 水洗瑰夏", ingredient_type:["瑰夏"], processing_method:["水洗"], flavor_profile:["茉莉花","玫瑰花","佛手柑","甜杏","水蜜桃","柠檬","蜂蜜"], category:"咖啡", price_unit:{ price:"198-218", unit:"份", currency:"¥" }, special_info:["独家甄选批次","2024 BOP水洗瑰夏组第6名"], origin:"巴拿马", region:"奇里基省 Cerro Punta", estate:"圣妮佐庄园", roast_level:"中焙" },
  { name_zh:"Finca Los Cenizo圣妮佐庄园 Accio独家甄选批次 日晒绿顶瑰夏", ingredient_type:["瑰夏"], processing_method:["日晒"], flavor_profile:["玫瑰花","香水柠檬","蜜瓜","杏桃","菠萝","玫瑰花蜜"], category:"咖啡", price_unit:{ price:"218-238", unit:"份", currency:"¥" }, special_info:["独家甄选批次","2024 BOP日晒瑰夏组第12名"], origin:"巴拿马", region:"奇里基省 Cerro Punta", estate:"圣妮佐庄园", roast_level:"中焙" },
  { name_zh:"Sophia Estate索菲亚庄园 晚收批次#25 日晒瑰夏", ingredient_type:["瑰夏"], processing_method:["日晒"], flavor_profile:["花香","佛手柑","柠檬草","蜜枣","果糖"], category:"咖啡", price_unit:{ price:"238-258", unit:"份", currency:"¥" }, special_info:["晚收批次","2024 BOP亚洲水洗组第5名","日晒组第5名"], origin:"巴拿马", region:"波奎特", estate:"索菲亚庄园", roast_level:"中焙" },
  { name_zh:"LongBoard冲浪板庄园 雾山地块 Ghands独家批次 MMGH42 蜜处理瑰夏", ingredient_type:["瑰夏"], processing_method:["蜜处理"], flavor_profile:["栀子花","金桔","红布林","粉心芭乐","水蜜桃","甘蔗汁","花蜜"], category:"咖啡", price_unit:{ price:"368-398", unit:"份", currency:"¥" }, special_info:["独家批次","2024 BOP水洗瑰夏组第14名"], origin:"巴拿马", region:"波奎特", estate:"冲浪板庄园", roast_level:"中焙" },
  { name_zh:"Finca Nuguo努果庄园 25新产季 精致水洗瑰夏#731", ingredient_type:["瑰夏"], processing_method:["精致水洗"], flavor_profile:["金银花","花蜜","糖果","血橙","白桃"], category:"咖啡", price_unit:{ price:"278-298", unit:"份", currency:"¥" }, special_info:["2024 BOP水洗瑰夏组第3名"], origin:"巴拿马", region:"奇里基省", estate:"努果庄园", roast_level:"中焙" },
  { name_zh:"Finca Deborah黛博拉庄园 25年新产季 共生Symbiosis 延长厌氧日晒瑰夏", ingredient_type:["瑰夏"], processing_method:["厌氧日晒","延长厌氧日晒"], flavor_profile:["红色花香","黑加仑","黑莓","波特酒","果脯","西梅"], category:"咖啡", price_unit:{ price:"168-188", unit:"份", currency:"¥" }, special_info:["2024 WBrC冠亚季军使用庄园豆"], origin:"巴拿马", region:"火山地区", estate:"黛博拉庄园", roast_level:"中焙" }
];

// ======== 价格解析（取区间平均） ========
function parsePriceAvg(p){
  if(!p) return NaN; const s = String(p).replace(/[^0-9\-]/g,'');
  if(!s) return NaN; const parts = s.split('-').map(Number);
  if(parts.length===1) return parts[0];
  if(parts.length>=2) return (parts[0]+parts[1])/2;
  return NaN;
}

// ======== 词表提取 ========
function uniq(arr){return [...new Set(arr.filter(Boolean))]}
const vocab = {
  ing: uniq(items.flatMap(x=>x.ingredient_type||[])).sort(),
  proc: uniq(items.flatMap(x=>x.processing_method||[])).sort(),
  org: uniq(items.map(x=>x.origin).filter(Boolean)).sort(),
  reg: uniq(items.map(x=>x.region).filter(Boolean)).sort(),
  est: uniq(items.map(x=>x.estate).filter(Boolean)).sort(),
  rst: uniq(items.map(x=>x.roast_level).filter(Boolean)).sort(),
  spc: uniq(items.flatMap(x=>x.special_info||[])).sort(),
  flv: uniq(items.flatMap(x=>x.flavor_profile||[])).sort()
};

// ======== 风味家族映射（示例规则，可替换为你的 KB） ========
const FAMILY_DEF = [
  {id:'floral',  label:'花香',  color:'#6aa9ff', keys:['花','玉兰','茉莉','栀子','咖啡花','龙眼花','橙花','黄色花香','红色花香']},
  {id:'citrus',  label:'柑橘',  color:'#5bd3c7', keys:['柠檬','柠檬草','佛手柑','橙','甜橙','柑橘','蜜橘','金桔','柑橘苏打','血橙']},
  {id:'stone',   label:'核果',  color:'#ffb86b', keys:['杏','杏桃','桃','水蜜桃','甜杏']},
  {id:'tropical',label:'热带',  color:'#ffd166', keys:['菠萝','芒果','百香果','阳光玫瑰','龙眼']},
  {id:'berry',   label:'莓果',  color:'#f78da7', keys:['莓','草莓','树莓','蔓越莓','黑莓','黑加仑']},
  {id:'grape',   label:'葡萄/酒',color:'#a78bfa', keys:['葡萄','白葡萄','白葡萄酒','气泡酒','波特酒']},
  {id:'sweet',   label:'甜感',  color:'#fcb7af', keys:['蜂蜜','蜂糖','花蜜','糖','糖果','蔗糖','果糖','香草','香草奶油','混合水果糖']},
  {id:'other',   label:'草本',  color:'#9db2ce', keys:['香料','草本']}
];

function flavorToFamily(tag){
  for(const fam of FAMILY_DEF){
    if(fam.keys.some(k=>tag.includes(k))) return fam.id;
  }
  return 'other';
}

// ======== 选中状态 ========
const state = {
  sort:'',
  selected:{ing:new Set(),proc:new Set(),org:new Set(),reg:new Set(),est:new Set(),rst:new Set(),spc:new Set(),flv:new Set(),fam:new Set()}
};

// ======== DOM refs ========
const grid = document.getElementById('grid');
const stats = document.getElementById('stats');
const activeFilters = document.getElementById('activeFilters');

// ======== 标签看板渲染 ========
function chip(id,label,set,on){
  const el=document.createElement('div');
  el.className='chip'+(set.has(id)?' active':'');
  el.textContent=label;
  el.onclick=()=>{ set.has(id)?set.delete(id):set.add(id); on?.(); };
  return el;
}
function renderBoard(){
  const mount=(id,gid,set)=>{
    const wrap=document.getElementById(id); wrap.innerHTML='';
    vocab[gid].forEach(v=>wrap.appendChild(chip(v,v,set,()=>{renderAll();})));
  };
  renderBoard.ingOnce||(renderBoard.ingOnce=true);
  mount('ingChips','ing',state.selected.ing);
  mount('procChips','proc',state.selected.proc);
  mount('orgChips','org',state.selected.org);
  mount('regChips','reg',state.selected.reg);
  mount('estChips','est',state.selected.est);
  mount('rstChips','rst',state.selected.rst);
  mount('spcChips','spc',state.selected.spc);
}

// ======== 过滤逻辑 ========
function matchGroup(vals, set){ if(!set.size) return true; return [...set].some(v=>vals?.includes(v)); }
function applyFilters(){
  let arr = items.slice();
  arr = arr.filter(it=>
    matchGroup(it.ingredient_type, state.selected.ing) &&
    matchGroup(it.processing_method, state.selected.proc) &&
    matchGroup([it.origin], state.selected.org) &&
    matchGroup([it.region], state.selected.reg) &&
    matchGroup([it.estate], state.selected.est) &&
    matchGroup([it.roast_level], state.selected.rst) &&
    matchGroup(it.special_info, state.selected.spc)
  );
  // 风味：优先具体风味，其次家族
  if(state.selected.flv.size){
    arr = arr.filter(it => it.flavor_profile && it.flavor_profile.some(f=>state.selected.flv.has(f)));
  } else if(state.selected.fam.size){
    arr = arr.filter(it => (it.flavor_profile||[]).some(f=> state.selected.fam.has(flavorToFamily(f)) ));
  }
  // 排序
  if(state.sort==='price-asc') arr = arr.slice().sort((a,b)=>parsePriceAvg(a.price_unit?.price)-parsePriceAvg(b.price_unit?.price));
  if(state.sort==='price-desc') arr = arr.slice().sort((a,b)=>parsePriceAvg(b.price_unit?.price)-parsePriceAvg(a.price_unit?.price));
  return arr;
}

// ======== 风味轮（SVG 饼图，按频次占比） ========
function calcFamilyCounts(arr){
  const counts = Object.fromEntries(FAMILY_DEF.map(f=>[f.id,0]));
  arr.forEach(it=> (it.flavor_profile||[]).forEach(tag=>{ counts[flavorToFamily(tag)]++; }));
  return counts;
}
function polar(cx,cy,r,ang){return [cx+r*Math.cos(ang), cy+r*Math.sin(ang)]}
function arcPath(cx,cy,r,ang0,ang1){
  const p0=polar(cx,cy,r,ang0), p1=polar(cx,cy,r,ang1);
  const large = (ang1-ang0)>Math.PI?1:0;
  return `M ${cx} ${cy} L ${p0[0]} ${p0[1]} A ${r} ${r} 0 ${large} 1 ${p1[0]} ${p1[1]} Z`;
}
function renderWheel(){
  const svg = document.getElementById('flavorWheel');
  svg.innerHTML='';
  const cx=180, cy=180, r=150;
  const filteredBase = applyFilters();
  const counts = calcFamilyCounts(filteredBase);
  const total = Object.values(counts).reduce((a,b)=>a+b,0) || 1; // 避免除 0
  let ang= -Math.PI/2; // 从上方开始
  FAMILY_DEF.forEach(f=>{
    const frac = counts[f.id]/total; const sweep = frac * Math.PI*2 || (1/FAMILY_DEF.length)*Math.PI*2; // 若为 0，用均分角展示可点击
    const path = document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d', arcPath(cx,cy,r,ang,ang+sweep));
    path.setAttribute('fill', f.color);
    path.setAttribute('opacity', state.selected.fam.size? (state.selected.fam.has(f.id)?1:0.25): 0.9);
    path.style.cursor='pointer';
    path.addEventListener('click', ()=>{ if(state.selected.fam.has(f.id)) state.selected.fam.delete(f.id); else state.selected.fam.add(f.id); state.selected.flv.clear(); renderAll(); });
    svg.appendChild(path);
    // 中心标签
    const mid = ang + sweep/2; const [lx,ly] = polar(cx,cy, r*0.62, mid);
    const text = document.createElementNS('http://www.w3.org/2000/svg','text');
    text.setAttribute('x', lx); text.setAttribute('y', ly); text.setAttribute('text-anchor','middle'); text.setAttribute('dominant-baseline','middle');
    text.setAttribute('font-size','12'); text.setAttribute('fill','#0b0c10');
    text.textContent = `${f.label} ${counts[f.id]||0}`;
    svg.appendChild(text);
    ang += sweep;
  });
  // 图例
  const legend = document.getElementById('wheelLegend');
  legend.innerHTML='';
  FAMILY_DEF.forEach(f=>{
    const el=document.createElement('div'); el.className='leg';
    const sw=document.createElement('span'); sw.className='sw'; sw.style.background=f.color; el.appendChild(sw);
    const tt=document.createElement('span'); tt.textContent=f.label; el.appendChild(tt);
    el.style.opacity = state.selected.fam.size? (state.selected.fam.has(f.id)?1:0.5):1;
    el.onclick=()=>{ if(state.selected.fam.has(f.id)) state.selected.fam.delete(f.id); else state.selected.fam.add(f.id); state.selected.flv.clear(); renderAll(); };
    legend.appendChild(el);
  });
}

// ======== 结果与徽标 ========
function renderCards(){
  const arr = applyFilters();
  const host = grid; host.innerHTML='';
  arr.forEach(it=>{
    const el=document.createElement('div'); el.className='card';
    const price = it.price_unit?.price ? `¥ ${it.price_unit.price}` : '—';
    const flavors = (it.flavor_profile||[]).slice(0,6).join(' / ');
    const proc = (it.processing_method||[]).join(' / ');
    el.innerHTML = `
      <div class="title">${it.name_zh}</div>
      <div class="meta">产地：${it.origin||'—'} · 产区：${it.region||'—'} · 庄园：${it.estate||'—'}</div>
      <div class="meta">处理：${proc||'—'} · 烘焙：${it.roast_level||'—'}</div>
      <div class="meta">风味：${flavors||'—'}</div>
      <div class="price">${price}</div>
    `;
    host.appendChild(el);
  });
  stats.textContent = `共 ${arr.length} 个结果`;
}

function renderBadges(){
  activeFilters.innerHTML='';
  const push=(label,set)=>{ [...set].forEach(v=>{ const b=document.createElement('div'); b.className='badge'; b.textContent=`${label}: ${v}`; activeFilters.appendChild(b); }); };
  push('品种', state.selected.ing);
  push('处理', state.selected.proc);
  push('国家', state.selected.org);
  push('产区', state.selected.reg);
  push('庄园', state.selected.est);
  push('烘焙', state.selected.rst);
  push('特色', state.selected.spc);
  // 家族
  if(state.selected.fam.size && !state.selected.flv.size){
    [...state.selected.fam].forEach(fid=>{
      const fam=FAMILY_DEF.find(x=>x.id===fid); if(!fam) return;
      const b=document.createElement('div'); b.className='badge'; b.textContent=`风味家族: ${fam.label}`; activeFilters.appendChild(b);
    })
  }
}

// ======== 事件 ========
const sortSelect=document.getElementById('sortSelect');
const resetBtn=document.getElementById('resetBtn');
sortSelect.onchange=(e)=>{ state.sort=e.target.value; renderCards(); };
resetBtn.onclick=()=>{ Object.values(state.selected).forEach(s=>s.clear()); state.sort=''; sortSelect.value=''; renderAll(); };

// ======== 总渲染 ========
function renderAll(){ renderBoard(); renderWheel(); renderBadges(); renderCards(); }
renderAll();
</script>
</body>
</html>
