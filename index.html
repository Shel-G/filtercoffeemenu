<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SEA Cupping Lineup • 互动地图 + 同步卡片</title>
<meta name="description" content="一个根据烘焙商国家进行筛选的互动咖啡豆地图。">

<!-- External Libraries -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">

<style>
  :root {
    --bg1: #0f0a06;
    --bg2: #2a1b12;
    --panel: rgba(17, 20, 24, 0.7);
    --ink: #f2efe9;
    --sub: #d0c6bb;
    --accent: #f7c96e;
    --border: rgba(247, 201, 110, 0.2);
  }
  * { box-sizing: border-box; }
  html, body { 
    height: 100%; 
    margin: 0;
    overflow: hidden; /* Prevent body scroll when detail panel is open */
  }
  body {
    font-family: 'Inter', 'Noto Sans SC', system-ui, -apple-system, sans-serif;
    background: radial-gradient(1200px 800px at 15% 10%, rgba(247, 201, 110, 0.1), transparent 60%),
                radial-gradient(900px 700px at 85% 90%, rgba(247, 201, 110, 0.08), transparent 60%),
                linear-gradient(135deg, var(--bg1), var(--bg2));
    color: var(--ink);
  }
  .wrap {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    padding: 1.5rem;
  }
  header {
    text-align: center;
    padding-bottom: 1.5rem;
    flex-shrink: 0;
  }
  h1 {
    font-size: clamp(2rem, 5vw, 2.8rem);
    margin: 0 0 1rem;
    color: var(--ink);
    font-weight: 800;
  }
  .intro-hint {
    font-size: 0.9rem;
    color: var(--sub);
    max-width: 600px;
    margin: -0.5rem auto 1.5rem;
    line-height: 1.6;
  }
  .filter-group {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    gap: .75rem;
  }
  .chip {
    background: rgba(0, 0, 0, .2);
    border: 1px solid var(--border);
    color: var(--sub);
    border-radius: 999px;
    padding: .6rem 1.2rem;
    cursor: pointer;
    font-weight: 600;
    transition: all .2s ease;
  }
  .chip:hover {
      background-color: rgba(0,0,0,.4);
      color: var(--ink);
  }
  .chip.active {
    background: var(--accent);
    color: var(--bg1);
    border-color: var(--accent);
    transform: scale(1.05);
  }
  #map-container {
      flex-grow: 1;
      position: relative;
  }
  #map {
    height: 100%;
    width: 100%;
    border-radius: 16px;
    background-color: var(--bg1);
    border: 1px solid var(--border);
  }

  /* --- Custom Map Marker & Popup Styles --- */
  .leaflet-div-icon {
    background: transparent;
    border: none;
  }
  .roaster-marker-container {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition: transform 0.2s ease;
    transform-origin: left center;
  }
  .roaster-marker-container:hover {
      transform: scale(1.1);
  }
  .roaster-dot-marker {
    background-color: var(--accent);
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 3px solid rgba(247, 201, 110, 0.5);
    box-shadow: 0 0 10px var(--accent);
    animation: pulse 2s infinite;
    flex-shrink: 0;
  }
   .roaster-name-label {
    background-color: rgba(15, 10, 6, 0.85);
    backdrop-filter: blur(4px);
    color: var(--accent);
    padding: 4px 8px;
    border-radius: 5px;
    border: 1px solid var(--border);
    font-size: 12px;
    font-weight: 600;
    white-space: nowrap;
    box-shadow: 0 2px 5px rgba(0,0,0,0.5);
  }

  @keyframes pulse {
    0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(247, 201, 110, 0.7); }
    70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(247, 201, 110, 0); }
    100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(247, 201, 110, 0); }
  }

  /* --- Detail Panel Styles --- */
  .detail-panel-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(5px);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
  }
  .detail-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 75vh;
      background: linear-gradient(135deg, var(--bg2), var(--bg1));
      border-top: 1px solid var(--border);
      border-radius: 20px 20px 0 0;
      z-index: 1001;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      padding: 2rem;
      overflow-y: auto;
      box-shadow: 0 -10px 30px rgba(0,0,0,0.3);
  }
   .detail-panel-overlay.is-visible {
      opacity: 1;
      visibility: visible;
  }
  .detail-panel-overlay.is-visible .detail-panel {
      transform: translateY(0);
  }
  .detail-content {
      max-width: 800px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr;
      gap: 2rem;
      opacity: 0;
      transform: translateY(15px);
      transition: opacity 0.3s ease 0.1s, transform 0.3s ease 0.1s;
  }
  .detail-panel-overlay.is-visible .detail-content {
      opacity: 1;
      transform: translateY(0);
  }
  @media(min-width: 768px){
      .detail-content { grid-template-columns: 300px 1fr; }
  }
  .detail-fig {
    position: relative;
    min-height: 250px;
    background-color: rgba(0,0,0,0.2);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .detail-fig.is-loading::after {
    content: '';
    width: 40px;
    height: 40px;
    border: 4px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    position: absolute;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  
  .detail-fig img {
      width: 100%;
      height: auto;
      border-radius: 12px;
      object-fit: cover;
      opacity: 0;
      transition: opacity 0.4s ease;
  }
  .detail-fig img.is-loaded {
      opacity: 1;
  }

  .detail-body .title {
      font-size: 2rem;
      margin: 0 0 .5rem;
      font-weight: 800;
      color: var(--accent);
  }
  .detail-body .meta {
      list-style: none;
      padding: 0;
      margin: 0;
      color: var(--sub);
      line-height: 1.8;
  }
  .detail-body .meta strong {
    color: var(--ink);
    font-weight: 600;
    min-width: 80px;
    display: inline-block;
  }
  .detail-body .flavors {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
  }
  .flavor-tag {
    background-color: rgba(0,0,0,0.3);
    border: 1px solid var(--border);
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
    font-size: 0.9rem;
  }
  .close-btn {
      position: absolute;
      top: 1rem;
      right: 1.5rem;
      background: none;
      border: none;
      color: var(--sub);
      font-size: 2rem;
      cursor: pointer;
      line-height: 1;
      z-index: 20;
  }
  .nav-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0,0,0,0.5);
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: none; /* Hidden by default */
    align-items: center;
    justify-content: center;
    font-size: 24px;
    cursor: pointer;
    user-select: none;
    transition: background 0.2s;
    z-index: 10;
  }
  .nav-arrow.visible {
      display: flex;
  }
  .nav-arrow:hover {
      background: rgba(0,0,0,0.8);
  }
  .nav-arrow.left { left: 10px; }
  .nav-arrow.right { right: 10px; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>SEA Cupping Lineup • 互动地图 + 同步卡片</h1>
    <p class="intro-hint">点击上方按烘焙商所在国家筛选，点击地图上烘焙商的地理位置标记，会自动展示此次杯测该烘焙商对应的豆子卡片信息。</p>
    <div class="filter-group" id="country-chips">
      <button class="chip active" data-filter="all">全部国家</button>
      <button class="chip" data-filter="马来西亚">马来西亚 🇲🇾</button>
      <button class="chip" data-filter="泰国">泰国 🇹🇭</button>
      <button class="chip" data-filter="新加坡">新加坡 🇸🇬</button>
    </div>
  </header>
  <main id="map-container">
    <div id="map"></div>
  </main>
</div>

<div class="detail-panel-overlay" id="detail-panel-overlay">
  <div class="detail-panel">
    <button class="close-btn" id="close-btn">&times;</button>
    <div class="detail-content" id="detail-content">
      <!-- Detailed bean info will be injected here -->
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {

  const beansData = [
    { "NO": 1, "国家": "马来西亚", "产区": "Johor", "豆种": "Peaberry", "庄园/生产者": "My Liberica, Jason Liew", "烘焙商": "One Half", "处理法": "JH 日晒 12天", "海拔": "26-30 masl", "风味描述": "甜菊、龙眼、红毛丹、莲心果、莎士" },
    { "NO": 2, "国家": "马来西亚", "产区": "Johor N26 Lot 1", "豆种": "Liberaca", "庄园/生产者": "My Liberica", "烘焙商": "Cloud Catcher Coffee", "处理法": "厌氧日晒 26天", "海拔": "0-20m", "风味描述": "黑樱桃、泡泡糖、红枣、甜菊" },
    { "NO": 3, "国家": "萨尔瓦多", "产区": "Santa Ana", "豆种": "Bourbon", "庄园/生产者": "El Martillo", "烘焙商": "VCR Coffee Roasters", "处理法": "厌氧日晒", "海拔": "1650-1700 masl", "风味描述": "百香果、黄葡萄干、杏" },
    { "NO": 4, "国家": "泰国", "产区": "Chiang Rai", "豆种": "Catuai, Typica", "庄园/生产者": "Hua Chang Nawin Yaesonkco", "烘焙商": "Curate Coffee Roasters", "处理法": "日晒转酵母发酵", "海拔": null, "风味描述": "朗姆酒、红樱桃、巧克力" },
    { "NO": 5, "国家": "泰国", "产区": "Tak", "豆种": "Catimor, Catuai, Typica", "庄园/生产者": "Chang Pao, Le Tor Gold", "烘焙商": "Lot of Taste", "处理法": "日晒", "海拔": null, "风味描述": "李子、蔗糖、黑葡萄干、余韵回甘" },
    { "NO": 6, "国家": "泰国", "产区": "Tak", "豆种": "Catimor, Catuai, Typica", "庄园/生产者": "Chang Pao, Le Tor Gold", "烘焙商": "Lot of Taste", "处理法": "日晒", "海拔": null, "风味描述": "玫瑰、树莓、西柚、葡萄酒、余韵回甘" },
    { "NO": 7, "国家": "泰国", "产区": "Mae chaem, Chiang Mai", "豆种": "Catimor, Catuai, Typica", "庄园/生产者": "Mae Jam", "烘焙商": "Graph Coffee Co.", "处理法": "传统水洗", "海拔": null, "风味描述": "红茶、红糖、凤梨、菠萝蜜" },
    { "NO": 8, "国家": "泰国", "产区": "Maejan Tai, Chiang Rai", "豆种": "Catimor, Mix", "庄园/生产者": "Liger", "烘焙商": "Akha Ama Phrasingh", "处理法": "日晒", "海拔": "1400 masl", "风味描述": "巧克力布朗尼、葡萄干、肉桂、热红酒、百香果" },
    { "NO": 9, "国家": "泰国", "产区": "Doi Chang, Chiang Rai", "豆种": "Typica, Catimor, Mix", "庄园/生产者": "Apiwat", "烘焙商": "Akha Ama Phrasingh", "处理法": "水洗", "海拔": "1200-1395 masl", "风味描述": "莲雾、西瓜、杨桃" },
    { "NO": 10, "国家": "秘鲁", "产区": null, "豆种": "Gesha", "庄园/生产者": "Lorenzo Arbildo", "烘焙商": "Fluid", "处理法": "水洗", "海拔": null, "风味描述": "草莓、罐头桃子、花茶" },
    { "NO": 11, "国家": "印度尼西亚", "产区": "Kintamani, Bali", "豆种": "USDA, Cobra, Kopyol", "庄园/生产者": "Nismara Singaraja", "烘焙商": "Tiong Hoe Specialty Coffee", "处理法": "传统水洗", "海拔": null, "风味描述": "红糖、甘蔗、干柿子" },
    { "NO": 12, "国家": "尼加拉瓜", "产区": "Jinotega", "豆种": "Catuai, Parainema", "庄园/生产者": "Ramon Blandino", "烘焙商": "Cloud Catcher Coffee", "处理法": "水洗", "海拔": "1600m", "风味描述": "莲雾、木槿花、桃子、橙子" },
    { "NO": 13, "国家": "埃塞俄比亚", "产区": "Gomoro Guji G1", "豆种": null, "庄园/生产者": null, "烘焙商": "Artisan Roast Coffee", "处理法": null, "海拔": null, "风味描述": "橙汁、芒果、柠檬味硬糖" },
    { "NO": 14, "国家": "坦桑尼亚", "产区": null, "豆种": "Bourbon (N39)", "庄园/生产者": "Various Smallholder Producers", "烘焙商": "Nylon Coffee Roasters", "处理法": "水洗", "海拔": null, "风味描述": "干浆果、黑布林、黑葡萄" }
  ];

  const roasterInfo = {
    "Akha Ama Phrasingh": { country: "泰国", city: "清迈", lat: 18.7915, lng: 98.9820 },
    "Graph Coffee Co.": { country: "泰国", city: "清迈", lat: 18.8030, lng: 98.9680 },
    "Lot of Taste": { country: "泰国", city: "清迈", lat: 18.7845, lng: 99.0007 },
    "Artisan Roast Coffee": { country: "马来西亚", city: "吉隆坡", lat: 3.1385, lng: 101.6300 },
    "Cloud Catcher Coffee": { country: "马来西亚", city: "吉隆坡", lat: 3.1114, lng: 101.6750 },
    "Curate Coffee Roasters": { country: "马来西亚", city: "吉隆坡", lat: 3.1610, lng: 101.7180 },
    "One Half": { country: "马来西亚", city: "吉隆坡", lat: 3.1080, lng: 101.6240 },
    "VCR Coffee Roasters": { country: "马来西亚", city: "吉隆坡", lat: 3.1440, lng: 101.7080 },
    "Fluid": { country: "新加坡", city: "新加坡", lat: 1.3005, lng: 103.8580 },
    "Nylon Coffee Roasters": { country: "新加坡", city: "新加坡", lat: 1.2770, lng: 103.8420 },
    "Tiong Hoe Specialty Coffee": { country: "新加坡", city: "新加坡", lat: 1.2980, lng: 103.8050 },
  };
  
  const beansByRoaster = beansData.reduce((acc, bean) => {
    const roasterName = bean.烘焙商;
    if (!acc[roasterName]) { acc[roasterName] = []; }
    acc[roasterName].push(bean);
    return acc;
  }, {});

  const mapElement = document.getElementById('map');
  const countryChips = document.getElementById('country-chips');
  const detailOverlay = document.getElementById('detail-panel-overlay');
  const detailContent = document.getElementById('detail-content');
  const closeBtn = document.getElementById('close-btn');
  
  let currentCountryFilter = 'all';
  let currentRoasterBeans = [];
  let currentBeanIndex = 0;

  const map = L.map(mapElement, { scrollWheelZoom: false }).setView([8, 105], 4);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
    maxZoom: 18
  }).addTo(map);

  const markers = L.layerGroup().addTo(map);

  function renderBeanInPanel(bean) {
    const flavorTags = bean.风味描述.split('、').map(flavor => `<span class="flavor-tag">${flavor}</span>`).join('');
    const showNav = currentRoasterBeans.length > 1;

    detailContent.innerHTML = `
      <div class="detail-fig is-loading">
          <img data-src="https://raw.githubusercontent.com/Shel-G/filtercoffeemenu/main/${bean.NO}.png" alt="${bean.产区}">
          <div class="nav-arrow left ${showNav ? 'visible' : ''}" id="nav-prev">&lt;</div>
          <div class="nav-arrow right ${showNav ? 'visible' : ''}" id="nav-next">&gt;</div>
      </div>
      <div class="detail-body">
          <h2 class="title">${bean.烘焙商} (#${bean.NO})</h2>
          <ul class="meta">
              <li><strong>产区:</strong> ${bean.产区 || bean.国家}</li>
              <li><strong>豆种:</strong> ${bean.豆种 || 'N/A'}</li>
              <li><strong>处理法:</strong> ${bean.处理法 || 'N/A'}</li>
              <li><strong>生产者:</strong> ${bean['庄园/生产者'] || 'N/A'}</li>
          </ul>
          <div class="flavors">${flavorTags}</div>
      </div>
    `;

    const figElement = detailContent.querySelector('.detail-fig');
    const imgElement = figElement.querySelector('img');
    
    imgElement.onload = () => {
        figElement.classList.remove('is-loading');
        imgElement.classList.add('is-loaded');
    };
    imgElement.onerror = () => {
        figElement.classList.remove('is-loading');
    };
    imgElement.src = imgElement.dataset.src;

    if(showNav) {
        document.getElementById('nav-prev').addEventListener('click', () => {
            currentBeanIndex = (currentBeanIndex - 1 + currentRoasterBeans.length) % currentRoasterBeans.length;
            renderBeanInPanel(currentRoasterBeans[currentBeanIndex]);
        });
        document.getElementById('nav-next').addEventListener('click', () => {
            currentBeanIndex = (currentBeanIndex + 1) % currentRoasterBeans.length;
            renderBeanInPanel(currentRoasterBeans[currentBeanIndex]);
        });
    }
  }

  function showDetailPanel(roasterName) {
      currentRoasterBeans = beansByRoaster[roasterName] || [];
      if (currentRoasterBeans.length === 0) return;
      
      currentBeanIndex = 0;
      renderBeanInPanel(currentRoasterBeans[currentBeanIndex]);
      detailOverlay.classList.add('is-visible');
  }

  function hideDetailPanel() {
      detailOverlay.classList.remove('is-visible');
  }

  function renderMarkers() {
      markers.clearLayers();
      const bounds = L.latLngBounds();
      
      Object.entries(roasterInfo).forEach(([roasterName, info]) => {
          if (currentCountryFilter !== 'all' && info.country !== currentCountryFilter) {
              return;
          }

          if (info.lat && info.lng) {
              const icon = L.divIcon({
                  className: 'leaflet-div-icon',
                  html: `<div class="roaster-marker-container">
                           <div class="roaster-dot-marker"></div>
                           <div class="roaster-name-label">${roasterName}</div>
                         </div>`,
                  iconSize: null,
                  iconAnchor: [6, 6]
              });

              const marker = L.marker([info.lat, info.lng], { icon: icon }).addTo(markers);
              
              marker.on('click', () => {
                showDetailPanel(roasterName);
              });
              bounds.extend([info.lat, info.lng]);
          }
      });

      if (bounds.isValid()) {
          map.fitBounds(bounds.pad(0.5));
      } else {
          map.setView([8, 105], 4);
      }
  }
  
  countryChips.addEventListener('click', (e) => {
    if (e.target.tagName === 'BUTTON') {
      countryChips.querySelector('.active').classList.remove('active');
      e.target.classList.add('active');
      currentCountryFilter = e.target.dataset.filter;
      renderMarkers();
    }
  });
  
  closeBtn.addEventListener('click', hideDetailPanel);
  detailOverlay.addEventListener('click', (e) => {
      if (e.target === detailOverlay) {
          hideDetailPanel();
      }
  });

  renderMarkers();
});
</script>
</body>
</html>

