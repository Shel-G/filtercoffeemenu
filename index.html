<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>咖啡标签可视化与组合推荐系统 Demo</title>

<!-- Google Fonts for better typography -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">

<!-- Leaflet Map Component -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>

<style>
  /* --- 1. 全局与布局样式 --- */
  :root{
    --bg-start: #432818; --bg-end: #120904;
    --panel-bg: rgba(255, 255, 255, 0.05); --panel-border: rgba(255, 255, 255, 0.1);
    --text-primary: #F5EFE6; --text-secondary: #D4CFC7; --text-muted: #A39B90;
    --accent: #FF8A00; --accent-hover: #FFA500;
    --chip-bg: rgba(0, 0, 0, 0.2); --chip-border: rgba(255, 255, 255, 0.1);
    --chip-active-bg: var(--accent); --card-bg: rgba(255, 255, 255, 0.03);
    --heart-liked: #e2264d;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  @keyframes heartBeat {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); }
  }

  *{box-sizing:border-box}
  body{
    margin:0; background: linear-gradient(180deg, var(--bg-start), var(--bg-end));
    background-attachment: fixed; color: var(--text-primary);
    font-family: 'Noto Sans SC', sans-serif; font-size: 14px; line-height: 1.65;
  }
  .wrap{max-width:1280px; margin:0 auto; padding:2rem}
  
  header { text-align: center; margin-bottom: 2.5rem; animation: fadeIn 0.8s ease-out; }
  h1{font-size: 2.5rem; margin:0 0 0.5rem; color: #fff; font-weight: 700; text-shadow: 0 2px 15px rgba(0,0,0,0.5);}
  h2{font-size:1.25rem; margin:0 0 1rem; color: var(--text-primary); font-weight: 500; border-bottom: 1px solid var(--panel-border); padding-bottom: 0.75rem;}
  h3{font-size:1rem; margin:0; font-weight: 500;}
  .note{color:var(--text-muted); font-size:1rem; font-weight: 300;}
  
  .panel{
    background: var(--panel-bg); border: 1px solid var(--panel-border);
    border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem;
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); animation: fadeIn 0.6s ease-out forwards;
  }
  
  .group{display:flex;flex-wrap:wrap;gap:10px}
  .pill{
    display:inline-flex;align-items:center;padding:8px 14px;border-radius:999px;
    background: var(--chip-bg); border: 1px solid var(--chip-border);
    color: var(--text-secondary); cursor:pointer; user-select:none; transition: all .2s ease;
    font-size: 13px;
  }
  .pill:hover{transform:translateY(-2px); background: rgba(255,255,255,0.1); box-shadow: 0 4px 15px rgba(0,0,0,0.2);}
  .pill.sel{background: var(--chip-active-bg); border-color:transparent; color:#fff; font-weight: 500; box-shadow: 0 2px 10px rgba(255, 138, 0, 0.4);}
  
  .grid-3{display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .kbd{font-size:12px;padding:4px 10px;border:1px solid var(--panel-border);border-radius:6px;background:rgba(0,0,0,0.3);color:var(--text-secondary)}
  .subttl{color:var(--text-secondary);font-size:12px;margin-bottom:8px; text-transform: uppercase; font-weight: 400;}

  /* --- 2. 可视化容器 & Tab & 卡片样式 --- */
  .seg{display:flex;gap:8px;background:rgba(0,0,0,0.25);border:1px solid var(--panel-border);border-radius:10px;padding:6px}
  .seg button{all:unset;padding:8px 14px;border-radius:8px;color:var(--text-secondary);cursor:pointer;white-space:nowrap;transition: all 0.2s ease;}
  .seg button:hover{background: rgba(255,255,255,0.1); color: var(--text-primary);}
  .seg button.active{background:var(--accent);color:#fff; box-shadow: 0 2px 10px rgba(255, 138, 0, 0.4);}
  
  .viz-container{min-height:420px;background:transparent;border:none;border-radius:12px;position:relative;overflow:hidden;padding:0; margin-top: 1rem;}
  .cards{display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:1rem; margin-top: 1rem;}
  .card{
    background: var(--card-bg); border: 1px solid var(--panel-border);
    border-radius: 12px; padding: 1rem; backdrop-filter: blur(5px);
    transition: transform 0.2s ease, box-shadow 0.2s ease; cursor: default;
    position: relative;
  }
  .card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.5), 0 0 0 1px var(--accent-hover); }
  .meta{color:var(--text-muted);font-size:12px;margin: 8px 0; min-height:32px}
  .badge{background:rgba(0,0,0,0.3);border:1px solid var(--chip-border);color:var(--text-secondary);padding:4px 8px;border-radius:999px;font-size:12px;margin-right:6px; margin-bottom: 6px; display: inline-block;}

  .card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; margin-bottom: 4px;}
  .card-header h3 { flex-grow: 1; }
  .like-button { cursor: pointer; padding: 4px; margin-top: -6px; margin-right: -6px; z-index: 10;}
  .heart-icon { width: 20px; height: 20px; stroke: var(--text-muted); stroke-width: 1.5; fill: none; transition: all 0.2s ease-in-out; }
  .like-button:hover .heart-icon { stroke: var(--accent); }
  .heart-icon.liked { stroke: var(--heart-liked); fill: var(--heart-liked); animation: heartBeat 0.3s ease-in-out; }

  /* --- 3. 特定组件样式 --- */
  #wheelSvg{width:100%;height:420px;display:block}
  .wheel-sector{transition:opacity .18s,transform .18s}
  .wheel-sector:hover{opacity:.95;transform:scale(1.015)}
  .wheel-label{font-size:12px;fill:var(--text-primary);font-weight:600}
  .wheel-label.l3{font-size:11px;fill:var(--text-secondary)}

  #map{width:100%;height:420px;border-radius:12px; background: #1a1a1a; border: 1px solid var(--panel-border);}
  .leaflet-container{background:transparent}
  .leaflet-control-zoom a { color: var(--accent) !important; background-color: rgba(0,0,0,0.5) !important; border-color: var(--panel-border) !important;}
  .leaflet-tile-pane { filter: brightness(0.7) contrast(1.1) saturate(0.8); }

  .q-panel{display:none; background:transparent; border:none; padding:0;}
  .q-panel.active{display:block}
  .q-actions{display:flex;justify-content:space-between;margin-top:1.5rem}
  .btn{all:unset;background:var(--accent);color:#fff;padding:10px 18px;border-radius:10px;cursor:pointer; text-align:center; transition: all 0.2s ease;}
  .btn:hover { background: var(--accent-hover); box-shadow: 0 4px 15px rgba(255, 138, 0, 0.4); }
  .btn[disabled]{opacity:.4;cursor:not-allowed; background: var(--chip-bg); box-shadow: none;}
  .btn.ghost{background:transparent;border:1px solid var(--accent)}
  .btn.ghost:hover { background: var(--accent); color: #fff;}
  .q-copy{background:rgba(0,0,0,0.2);border:1px dashed var(--panel-border);border-radius:10px;padding:1rem;color:var(--text-secondary); margin: 1rem 0 1.5rem;}
  #ai-cards{grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));}

  .xy-wrap{display:grid;grid-template-columns:1fr 320px;gap:1.5rem;width:100%}
  .xy-panel{background:transparent;border:none;padding:0}
  .xy-grid{overflow:auto;border:1px solid var(--panel-border);border-radius:10px}
  .xy-table{border-collapse:separate;border-spacing:0;min-width:100%}
  .xy-table th,.xy-table td{border-bottom:1px solid var(--panel-border)}
  .xy-table th{position:sticky;top:0;background:rgba(0,0,0,0.4);backdrop-filter: blur(5px);color:var(--text-secondary)}
  .xy-table th,.xy-table td{padding:12px 14px;text-align:center;white-space:nowrap}
  .xy-rowhd{position:sticky;left:0;background:rgba(0,0,0,0.4);text-align:left}
  .xy-cell{cursor:pointer;transition:background .15s}
  .xy-cell:hover{background:rgba(255, 138, 0, 0.15)}
  .xy-badge{display:inline-block;min-width:28px;border-radius:8px;padding:3px 6px;background:var(--chip-bg);border:1px solid var(--chip-border);color:var(--text-secondary);font-size:12px}
  .xy-heat-0{background:transparent}
  .xy-heat-1{background:rgba(255, 138, 0, 0.1)}
  .xy-heat-2{background:rgba(255, 138, 0, 0.2)}
  .xy-heat-3{background:rgba(255, 138, 0, 0.3)}
  .xy-heat-4{background:rgba(255, 138, 0, 0.4)}
  .xy-chip{display:inline-block;padding:4px 8px;border-radius:999px;background:var(--chip-bg);border:1px solid var(--chip-border);color:var(--text-secondary);font-size:12px}
  .xy-card{background:var(--card-bg);border:1px solid var(--panel-border);border-radius:10px;padding:10px;margin-bottom:8px}
  .xy-meta{color:var(--text-muted);font-size:12px;margin-top:4px}
  
  #results-panel { display: none; }

  /* --- 4. 移动端响应式适配 --- */
  @media (max-width: 768px) {
    body { font-size: 13px; }
    .wrap { padding: 1rem; }
    h1 { font-size: 1.8rem; }
    h2 { font-size: 1.1rem; }
    .panel { padding: 1rem; }
    .grid-3, .cards { grid-template-columns: 1fr; }
    .seg { flex-wrap: wrap; }
    .viz-container { min-height: 380px; }
    .xy-wrap { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>风味探索 · 咖啡世界</h1>
    <div class="note">一个集成了AI 推荐｜探索式筛选｜可视化分析的交互式咖啡菜单</div>
  </header>

  <!-- 顶部筛选器 -->
  <section class="panel">
    <h2>风味筛选器</h2>
    <div class="grid-3">
      <div>
        <div class="subttl">品种 (Variety)</div>
        <div class="group" id="ingGroup"></div>
      </div>
      <div>
        <div class="subttl">处理方式 (Process)</div>
        <div class="group" id="procGroup"></div>
      </div>
      <div>
        <div class="subttl">风味大类 (Flavor)</div>
        <div class="group" id="flvGroup"></div>
      </div>
      <div>
        <div class="subttl">国家 (Country)</div>
        <div class="group" id="orgCountry"></div>
      </div>
      <div>
        <div class="subttl">产区 (Region)</div>
        <div class="group" id="orgRegion"></div>
      </div>
      <div>
        <div class="subttl">庄园 (Estate)</div>
        <div class="group" id="orgEstate"></div>
      </div>
      <div>
        <div class="subttl">烘焙度 (Roast)</div>
        <div class="group" id="rstGroup"></div>
      </div>
      <div>
        <div class="subttl">特色 (Special)</div>
        <div class="group" id="spcGroup"></div>
      </div>
      <div>
        <div class="subttl">价格区间 (Price Range)</div>
        <div class="row">
          <input type="range" id="priceMin" min="120" max="400" step="1" value="120" style="width:100px"/>
          <input type="range" id="priceMax" min="120" max="400" step="1" value="400" style="width:100px"/>
          <span class="kbd" id="priceView">¥120 - ¥400</span>
        </div>
      </div>
    </div>
  </section>

  <!-- 可视化分析区域 -->
  <section class="panel">
    <div class="row" style="justify-content:space-between;align-items:center;">
      <h2>可视化分析</h2>
      <div class="seg" id="vizTabs">
        <!-- 顺序调整 -->
        <button class="active" data-pane="ai">AI 问答推荐</button>
        <button data-pane="wheel">风味轮</button>
        <button data-pane="map">产区地图</button>
        <button data-pane="matrix">口感矩阵</button>
      </div>
    </div>

    <!-- Pane Container -->
    <div class="viz-container">
      <!-- 顺序调整 -->
      <div class="pane" id="pane-ai" style="display:block">
        <section class="q-panel active" id="q1">
          <h2>Q1. 今天想要什么感觉？</h2>
          <div class="group" data-q="q1">
            <span class="pill" data-value="floral">🌸 花香清新 (茉莉/玫瑰)</span>
            <span class="pill" data-value="citrus">🍊 果香活泼 (柑橘/佛手柑)</span>
            <span class="pill" data-value="sweet">🍯 甜润温暖 (蜂蜜/蔗糖)</span>
            <span class="pill" data-value="fermented">🥂 醇馥微醺 (气泡酒/酒香)</span>
          </div>
          <div class="q-actions"><button class="btn" id="next1" disabled>下一题</button></div>
        </section>
        <section class="q-panel" id="q2">
          <h2>Q2. 更偏向哪种产地风格？</h2>
          <div class="group" data-q="q2">
            <span class="pill" data-value="boquete">🇵🇦 波奎特 Boquete</span>
            <span class="pill" data-value="volcan">🇵🇦 沃肯 Volcán</span>
            <span class="pill" data-value="chiriqui">🇵🇦 奇里基 Chiriquí</span>
            <span class="pill" data-value="any">🌍 惊喜随缘 (不限产区)</span>
          </div>
          <div class="q-actions"><button class="btn ghost" id="back2">上一步</button><button class="btn" id="next2" disabled>下一题</button></div>
        </section>
        <section class="q-panel" id="q3">
          <h2>Q3. 今天的能量指数？</h2>
          <div class="group" data-q="q3">
            <span class="pill" data-value="light">🔆 轻盈通透 (Light)</span>
            <span class="pill" data-value="medium">🌗 平衡顺滑 (Medium)</span>
            <span class="pill" data-value="dark">🌑 浓郁厚重 (Dark)</span>
            <span class="pill" data-value="special">💎 想要特别一点 (限量/获奖)</span>
          </div>
          <div class="q-actions"><button class="btn ghost" id="back3">上一步</button><button class="btn" id="next3" disabled>最后一题</button></div>
        </section>
        <section class="q-panel" id="q4">
          <h2>Q4. 预算感觉如何？</h2>
          <div class="group" data-q="q4">
            <span class="pill" data-value="low">💤 随便尝尝 (≤168)</span>
            <span class="pill" data-value="mid">🙂 舒适选择 (169–198)</span>
            <span class="pill" data-value="high">🤩 奢一点 (199–258)</span>
            <span class="pill" data-value="ultra">👑 冠军体验 (≥259)</span>
          </div>
          <div class="q-actions"><button class="btn ghost" id="back4">上一步</button><button class="btn" id="see">生成推荐</button></div>
        </section>
        <section id="ai-result" style="display:none">
          <h2>AI 为您推荐</h2>
          <div class="q-copy" id="recoCopy"></div>
          <div class="cards" id="ai-cards"></div>
        </section>
      </div>
      <div class="pane" id="pane-wheel" style="display:none; padding:0; overflow:hidden;">
        <svg id="wheelSvg" viewBox="-220 -220 440 440" aria-label="风味轮"></svg>
      </div>
      <div class="pane" id="pane-map" style="display:none; padding:0; overflow:hidden;">
        <div id="map"></div>
      </div>
      <div class="pane" id="pane-matrix" style="display:none"></div>
    </div>
  </section>

  <!-- 结果列表 -->
  <section class="panel" id="results-panel">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2>筛选结果</h2>
      <div class="note" id="countHint"></div>
    </div>
    <div class="cards" id="cards"></div>
  </section>
</div>

<script>
/* ====== 0. 中英双语标签字典 ====== */
const LABEL_MAP = {
    'ing.variety.gesha': { zh: '瑰夏', en: 'Gesha' },
    'proc.coffee.natural': { zh: '日晒', en: 'Natural' },
    'proc.coffee.washed': { zh: '水洗', en: 'Washed' },
    'proc.coffee.honey': { zh: '蜜处理', en: 'Honey' },
    'proc.coffee.special': { zh: '特殊处理', en: 'Special' },
    'flv.floral': { zh: '花香', en: 'Floral' }, 'flv.fruit.citrus': { zh: '柑橘', en: 'Citrus' }, 'flv.fruit.stonefruit': { zh: '核果', en: 'Stone Fruit' }, 'flv.fruit.tropical': { zh: '热带水果', en: 'Tropical' }, 'flv.fruit.berry': { zh: '莓果', en: 'Berry' }, 'flv.sweet': { zh: '甜感', en: 'Sweet' }, 'flv.fermented': { zh: '发酵/酒香', en: 'Fermented/Winey' }, 'flv.herb': { zh: '草本', en: 'Herbal' }, 'flv.mouthfeel': { zh: '口感', en: 'Mouthfeel' }, 'flv.spice': { zh: '香料', en: 'Spice' }, 'flv.taste': { zh: '风味', en: 'Taste' }, 'flv.fruit': { zh: '水果', en: 'Fruit' }, 'flv.floral.orange-blossom': { zh: '橙花', en: 'Orange Blossom' }, 'flv.fruit.citrus.sweet-orange': { zh: '甜橙', en: 'Sweet Orange' }, 'flv.fruit.stonefruit.apricot': { zh: '杏子', en: 'Apricot' }, 'flv.fruit.tropical.lychee': { zh: '荔枝', en: 'Lychee' }, 'flv.sweet.candy': { zh: '糖果', en: 'Candy' }, 'flv.floral.magnolia': { zh: '木兰', en: 'Magnolia' }, 'flv.fruit.citrus.orange-juice': { zh: '橙汁', en: 'Orange Juice' }, 'flv.fruit.stonefruit.peach-white': { zh: '白桃', en: 'White Peach' }, 'flv.fruit.grape': { zh: '葡萄', en: 'Grape' }, 'flv.sweet.honey': { zh: '蜂蜜', en: 'Honey' }, 'flv.floral.rose': { zh: '玫瑰', en: 'Rose' }, 'flv.fruit.tropical.pineapple': { zh: '菠萝', en: 'Pineapple' }, 'flv.fruit.tropical.mango': { zh: '芒果', en: 'Mango' }, 'flv.fruit.grape.white-grape': { zh: '白葡萄', en: 'White Grape' }, 'flv.mouthfeel.creamy-vanilla': { zh: '奶油香草', en: 'Creamy Vanilla' }, 'flv.fermented.white-wine-finish': { zh: '白葡萄酒尾韵', en: 'White Wine Finish' }, 'flv.floral.jasmine': { zh: '茉莉', en: 'Jasmine' }, 'flv.floral.coffeeblossom': { zh: '咖啡花', en: 'Coffee Blossom' }, 'flv.fruit.citrus.bergamot': { zh: '佛手柑', en: 'Bergamot' }, 'flv.sweet.lemon-candy': { zh: '柠檬糖', en: 'Lemon Candy' }, 'flv.taste.bright-acidity': { zh: '明亮酸质', en: 'Bright Acidity' }, 'flv.sweet.cane-sugar': { zh: '蔗糖', en: 'Cane Sugar' }, 'flv.floral.yellow-floral': { zh: '黄花', en: 'Yellow Floral' }, 'flv.fermented.sparkling-wine': { zh: '气泡酒', en: 'Sparkling Wine' }, 'flv.spice.vanilla': { zh: '香草', en: 'Vanilla' }, 'flv.sweet.nectar': { zh: '花蜜', en: 'Nectar' }, 'flv.fruit.citrus.blood-orange': { zh: '血橙', en: 'Blood Orange' }, 'flv.fruit.berry.raspberry': { zh: '覆盆子', en: 'Raspberry' }, 'flv.fruit.berry.strawberry-jam': { zh: '草莓酱', en: 'Strawberry Jam' }, 'flv.fruit.tropical.passionfruit': { zh: '百香果', en: 'Passionfruit' }, 'flv.fruit.plum.honey-plum': { zh: '蜜李', en: 'Honey Plum' }, 'flv.herb.lemongrass': { zh: '柠檬草', en: 'Lemongrass' }, 'flv.fruit.stonefruit.peach': { zh: '桃子', en: 'Peach' }, 'flv.floral.longan-flower': { zh: '龙眼花', en: 'Longan Flower' }, 'flv.fruit.tropical.longan': { zh: '龙眼', en: 'Longan' }, 'flv.fruit.berry.cranberry': { zh: '蔓越莓', en: 'Cranberry' }, 'flv.fruit.stonefruit.apricot-sweet': { zh: '甜杏', en: 'Sweet Apricot' }, 'flv.fruit.citrus.lemon': { zh: '柠檬', en: 'Lemon' }, 'flv.fruit.citrus.lemon-perfume': { zh: '香水柠檬', en: 'Perfume Lemon' }, 'flv.fruit.melon.honeydew': { zh: '蜜瓜', en: 'Honeydew' }, 'flv.sweet.fruit-sugar': { zh: '果糖', en: 'Fruit Sugar' }, 'flv.floral.gardenia': { zh: '栀子花', en: 'Gardenia' }, 'flv.fruit.citrus.kumquat': { zh: '金橘', en: 'Kumquat' }, 'flv.fruit.plum.red-plum': { zh: '红李', en: 'Red Plum' }, 'flv.fruit.tropical.guava-pink': { zh: '粉红番石榴', en: 'Pink Guava' }, 'flv.sweet.cane-juice': { zh: '甘蔗汁', en: 'Cane Juice' }, 'flv.fruit.stonefruit.white-peach': { zh: '白桃', en: 'White Peach' }, 'flv.floral.red-floral': { zh: '红花', en: 'Red Floral' }, 'flv.fruit.berry.blackcurrant': { zh: '黑加仑', en: 'Blackcurrant' }, 'flv.fruit.berry.blackberry': { zh: '黑莓', en: 'Blackberry' }, 'flv.fermented.port-wine': { zh: '波特酒', en: 'Port Wine' }, 'flv.fruit.plum': { zh: '李子', en: 'Plum' },
    'medium': { zh: '中度烘焙', en: 'Medium' }, 'light': { zh: '浅度烘焙', en: 'Light' }, 'dark': { zh: '深度烘焙', en: 'Dark' },
    'awarded': { zh: '获奖批次', en: 'Awarded' }, 'limited': { zh: '限量批次', en: 'Limited' }, 'label.red': { zh: '红标', en: 'Red Label' }, 'harvest.late': { zh: '晚收', en: 'Late Harvest' },
    'panama': { zh: '巴拿马', en: 'Panama' }, 'boquete': { zh: '波奎特', en: 'Boquete' }, 'volcan': { zh: '沃肯', en: 'Volcán' }, 'chiriqui': { zh: '奇里基', en: 'Chiriquí' }, 'santamaria': { zh: '圣塔玛利亚', en: 'Santa Maria' }, 'elida': { zh: '艾力达', en: 'Elida' }, 'altieri': { zh: '阿尔铁里', en: 'Altieri' }, 'deborah': { zh: '黛博拉', en: 'Deborah' }, 'flyingpumas': { zh: '飞豹', en: 'Flying Pumas' }, 'esmeralda': { zh: '翡翠', en: 'Esmeralda' }, 'cenizo': { zh: '圣妮佐', en: 'Cenizo' }, 'sophia': { zh: '索菲亚', en: 'Sophia' }, 'longboard': { zh: '冲浪板', en: 'LongBoard' }, 'nuguo': { zh: '努果', en: 'Nuguo' }
};

/* ====== 1. 统一数据集 (修正 proc 字段) ====== */
const ITEMS = [
  {name:"圣塔玛利亚庄园 Ghands", org:"org.panama.chiriqui.santamaria", proc_raw:["natural","anaerobic"], flv:["flv.floral.orange-blossom","flv.fruit.citrus.sweet-orange","flv.fruit.stonefruit.apricot","flv.fruit.tropical.lychee","flv.fruit.berry","flv.sweet.candy"], rst:"medium", price:[168,188], spc:["awarded","limited"], ing:["ing.variety.gesha"]},
  {name:"艾力达 VUELTA EGN DRD 瑰夏暗房日晒", org:"org.panama.boquete.elida", proc_raw:["darkroom-natural","natural"], flv:["flv.floral.magnolia","flv.fruit.citrus.orange-juice","flv.fruit.stonefruit.peach-white","flv.fruit.grape","flv.sweet.honey"], rst:"medium", price:[158,168], spc:["awarded"], ing:["ing.variety.gesha"]},
  {name:"阿尔铁里 ALESSA 绿顶瑰夏", org:"org.panama.boquete.altieri", proc_raw:["natural","fermentation"], flv:["flv.floral.rose","flv.fruit.tropical.pineapple","flv.fruit.tropical.mango","flv.fruit.grape.white-grape","flv.mouthfeel.creamy-vanilla","flv.fermented.white-wine-finish"], rst:"medium", price:[128,148], spc:["awarded"], ing:["ing.variety.gesha"]},
  {name:"艾力达 Aguacate EGW DRD 水洗暗房干燥", org:"org.panama.boquete.elida", proc_raw:["darkroom-washed","washed"], flv:["flv.floral.jasmine","flv.floral.coffeeblossom","flv.floral","flv.fruit.citrus.bergamot","flv.sweet.lemon-candy","flv.taste.bright-acidity"], rst:"medium", price:[158,168], spc:["awarded"], ing:["ing.variety.gesha"]},
  {name:"艾力达 VUELTA EGW 水洗绿顶", org:"org.panama.boquete.elida", proc_raw:["washed"], flv:["flv.floral.magnolia","flv.floral","flv.fruit.citrus.bergamot","flv.sweet.cane-sugar","flv.taste.bright-acidity"], rst:"medium", price:[158,168], spc:["awarded"], ing:["ing.variety.gesha"]},
  {name:"黛博拉 Vivid 二氧化碳日晒发酵", org:"org.panama.volcan.deborah", proc_raw:["natural","carbonic-maceration","fermentation"], flv:["flv.floral.yellow-floral","flv.fermented.sparkling-wine","flv.fruit.stonefruit.peach-white","flv.spice.vanilla","flv.mouthfeel.creamy-vanilla"], rst:"medium", price:[168,188], spc:["awarded"], ing:["ing.variety.gesha"]},
  {name:"黛博拉 Echo 带果皮碳浸水洗", org:"org.panama.volcan.deborah", proc_raw:["carbonic-with-skin","washed"], flv:["flv.floral","flv.sweet.nectar","flv.fruit.citrus.blood-orange","flv.fruit.berry.raspberry","flv.fruit.citrus.sweet-orange","flv.fruit.berry.strawberry-jam"], rst:"medium", price:[168,188], spc:["awarded"], ing:["ing.variety.gesha"]},
  {name:"飞豹 日晒瑰夏 FPNLG24003", org:"org.panama.volcan.flyingpumas", proc_raw:["natural"], flv:["flv.fruit.tropical","flv.fruit.tropical.mango","flv.fruit.tropical.passionfruit","flv.fruit.citrus.sweet-orange","flv.fruit.plum.honey-plum"], rst:"medium", price:[178,198], spc:[], ing:["ing.variety.gesha"]},
  {name:"飞豹 动态发酵水洗 JAGUARUNDI", org:"org.panama.volcan.flyingpumas", proc_raw:["dynamic-fermentation","washed"], flv:["flv.herb.lemongrass","flv.fruit.citrus.bergamot","flv.fruit.citrus","flv.fruit.stonefruit.peach"], rst:"medium", price:[178,198], spc:["limited"], ing:["ing.variety.gesha"]},
  {name:"飞豹 开放发酵水洗 FPNLG24010", org:"org.panama.volcan.flyingpumas", proc_raw:["open-fermentation","washed"], flv:["flv.floral.longan-flower","flv.floral","flv.fruit.citrus.bergamot","flv.fruit.citrus.sweet-orange","flv.fruit.stonefruit.peach","flv.fruit.tropical.longan","flv.fruit.citrus"], rst:"medium", price:[178,198], spc:[], ing:["ing.variety.gesha"]},
  {name:"翡翠 红标日晒瑰夏", org:"org.panama.boquete.esmeralda", proc_raw:["natural"], flv:["flv.floral.magnolia","flv.herb.lemongrass","flv.fruit.citrus","flv.fruit.citrus.sweet-orange","flv.fruit.berry.cranberry","flv.fruit.tropical.passionfruit","flv.taste.bright-acidity"], rst:"medium", price:[178,198], spc:["awarded","label.red"], ing:["ing.variety.gesha"]},
  {name:"圣妮佐 水洗瑰夏", org:"org.panama.chiriqui.cenizo", proc_raw:["washed"], flv:["flv.floral.jasmine","flv.floral.rose","flv.fruit.citrus.bergamot","flv.fruit.stonefruit.apricot-sweet","flv.fruit.stonefruit.peach-white","flv.fruit.citrus.lemon","flv.sweet.honey"], rst:"medium", price:[198,218], spc:["limited","awarded"], ing:["ing.variety.gesha"]},
  {name:"圣妮佐 日晒绿顶瑰夏", org:"org.panama.chiriqui.cenizo", proc_raw:["natural"], flv:["flv.floral.rose","flv.fruit.citrus.lemon-perfume","flv.fruit.melon.honeydew","flv.fruit.stonefruit.apricot","flv.fruit.tropical.pineapple","flv.sweet.nectar"], rst:"medium", price:[218,238], spc:["limited","awarded"], ing:["ing.variety.gesha"]},
  {name:"索菲亚 晚收#25 日晒瑰夏", org:"org.panama.boquete.sophia", proc_raw:["natural"], flv:["flv.floral","flv.fruit.citrus.bergamot","flv.herb.lemongrass","flv.sweet","flv.sweet.fruit-sugar"], rst:"medium", price:[238,258], spc:["harvest.late","awarded"], ing:["ing.variety.gesha"]},
  {name:"冲浪板 雾山地块 蜜处理瑰夏", org:"org.panama.boquete.longboard", proc_raw:["honey"], flv:["flv.floral.gardenia","flv.fruit.citrus.kumquat","flv.fruit.plum.red-plum","flv.fruit.tropical.guava-pink","flv.fruit.stonefruit.peach-white","flv.sweet.cane-juice","flv.sweet.nectar"], rst:"medium", price:[368,398], spc:["limited","awarded"], ing:["ing.variety.gesha"]},
  {name:"努果 精致水洗瑰夏 #731", org:"org.panama.chiriqui.nuguo", proc_raw:["refined-washed"], flv:["flv.floral","flv.sweet.nectar","flv.sweet.candy","flv.fruit.citrus.blood-orange","flv.fruit.stonefruit.white-peach"], rst:"medium", price:[278,298], spc:["awarded"], ing:["ing.variety.gesha"]},
  {name:"黛博拉 Symbiosis 延长厌氧日晒", org:"org.panama.volcan.deborah", proc_raw:["extended-anaerobic-natural"], flv:["flv.floral.red-floral","flv.fruit.berry.blackcurrant","flv.fruit.berry.blackberry","flv.fermented.port-wine","flv.sweet","flv.fruit.plum"], rst:"medium", price:[168,188], spc:["awarded"], ing:["ing.variety.gesha"]},
];

// Data pre-processing to categorize processing methods
const SPECIAL_PROC_KEYWORDS = ['anaerobic', 'carbonic', 'fermentation', 'darkroom', 'dynamic', 'extended', 'refined'];
ITEMS.forEach(item => {
    const procString = item.proc_raw.join(' ');
    let isSpecial = item.proc_raw.length > 1 || SPECIAL_PROC_KEYWORDS.some(kw => procString.includes(kw));
    
    // Check for primary methods first, then override if special
    if (procString.includes('washed')) item.proc = 'proc.coffee.washed';
    else if (procString.includes('natural')) item.proc = 'proc.coffee.natural';
    else if (procString.includes('honey')) item.proc = 'proc.coffee.honey';
    else isSpecial = true; // If none of the main 3, it's special

    if (isSpecial) item.proc = 'proc.coffee.special';
});


const GEO = { "panama.boquete": {lat:8.78, lon:-82.43, label:"Boquete"}, "panama.volcan":  {lat:8.77, lon:-82.64, label:"Volcán"}, "panama.chiriqui":{lat:8.60, lon:-82.55, label:"Chiriquí"}, "panama.boquete.elida": {lat:8.796, lon:-82.445, label:"Elida"}, "panama.boquete.altieri": {lat:8.775, lon:-82.445, label:"Altieri"}, "panama.boquete.esmeralda": {lat:8.789, lon:-82.43,  label:"Esmeralda"}, "panama.boquete.longboard": {lat:8.790, lon:-82.435, label:"LongBoard"}, "panama.boquete.sophia": {lat:8.792, lon:-82.432, label:"Sophia"}, "panama.volcan.deborah": {lat:8.790, lon:-82.640, label:"Deborah"}, "panama.volcan.flyingpumas": {lat:8.795, lon:-82.620, label:"Flying Pumas"}, "panama.chiriqui.cenizo": {lat:8.848, lon:-82.570, label:"Los Cenizo"}, "panama.chiriqui.nuguo": {lat:8.900, lon:-82.830, label:"Nuguo"}, "panama.chiriqui.santamaria":{lat:8.800, lon:-82.450, label:"Santa Maria"} };

/* ====== 2. 全局状态与核心逻辑 ====== */
const SELECTED = { ing:new Set(), proc:new Set(), rst:new Set(), spc:new Set(), flvL2:new Set(), flvL3:new Set(), org:{country:new Set(), region:new Set(), estate:new Set()}, price:[120,400] };
const avgPrice = it => (it.price[0]+it.price[1])/2;
const prefix = (t,n)=> t.split('.').slice(0,n).join('.');
const last = t => t.split('.').slice(-1)[0];
function tally(arr, keyFn){ const m=new Map(); arr.forEach(x=>{const k=keyFn(x); m.set(k,(m.get(k)||0)+1) }); return [...m.entries()].sort((a,b)=>b[1]-a[1]); }
function getLabel(key) { const label = LABEL_MAP[key]; return label ? `${label.zh} ${label.en}` : key; }
function getLabelZh(key) { const label = LABEL_MAP[key]; return label ? label.zh : last(key).replace(/-/g,' ');}

function orgMatch(it){
  const {country,region,estate} = SELECTED.org;
  if(!country.size && !region.size && !estate.size) return true;
  const [_,c,r,e] = it.org.split('.'); let ok=true;
  if(country.size) ok = ok && [...country].some(k=>k===c);
  if(region.size)  ok = ok && [...region].some(k=>k===`${c}.${r}`);
  if(estate.size)  ok = ok && [...estate].some(k=>k===`${c}.${r}.${e}`);
  return ok;
}
function matchOR(set, arr, mapfn){ if(!set.size) return true; const keys=[...set]; return keys.some(k=> arr.some(t=>mapfn(t,k))); }
function areFiltersActive() {
    return SELECTED.ing.size > 0 || SELECTED.proc.size > 0 || SELECTED.rst.size > 0 ||
           SELECTED.spc.size > 0 || SELECTED.flvL2.size > 0 || SELECTED.flvL3.size > 0 ||
           SELECTED.org.country.size > 0 || SELECTED.org.region.size > 0 || SELECTED.org.estate.size > 0 ||
           SELECTED.price[0] !== 120 || SELECTED.price[1] !== 400;
}
function filterItems(){
  return ITEMS.filter(it=>{
    const ap = avgPrice(it);
    if(ap < SELECTED.price[0] || ap > SELECTED.price[1]) return false;
    if(SELECTED.proc.size && !SELECTED.proc.has(it.proc)) return false; 
    if(!matchOR(SELECTED.ing, it.ing||[], (t,k)=>t===k)) return false;
    if(!matchOR(SELECTED.rst, [it.rst], (t,k)=>t===k)) return false;
    if(!matchOR(SELECTED.spc, it.spc||[], (t,k)=>t===k)) return false;
    if(SELECTED.flvL3.size && !matchOR(SELECTED.flvL3, it.flv||[], (t,k)=>prefix(t,3)===k)) return false;
    if(SELECTED.flvL2.size && !matchOR(SELECTED.flvL2, it.flv||[], (t,k)=>prefix(t,2)===k)) return false;
    if(!orgMatch(it)) return false;
    return true;
  });
}
function buildCounts(list){
  const C={ ing:new Map(), proc:new Map(), rst:new Map(), spc:new Map(), flvL2:new Map(), org:{country:new Map(), region:new Map(), estate:new Map()} };
  list.forEach(it=>{
    (it.ing||[]).forEach(t=>C.ing.set(t,(C.ing.get(t)||0)+1));
    C.proc.set(it.proc, (C.proc.get(it.proc) || 0) + 1);
    C.rst.set(it.rst,(C.rst.get(it.rst)||0)+1);
    (it.spc||[]).forEach(t=>C.spc.set(t,(C.spc.get(t)||0)+1));
    (it.flv||[]).forEach(t=>{const k=prefix(t,2); C.flvL2.set(k,(C.flvL2.get(k)||0)+1)});
    const [_,c,r,e] = it.org.split('.'); C.org.country.set(c,(C.org.country.get(c)||0)+1); C.org.region.set(`${c}.${r}`,(C.org.region.get(`${c}.${r}`)||0)+1); C.org.estate.set(`${c}.${r}.${e}`,(C.org.estate.get(`${c}.${r}.${e}`)||0)+1);
  });
  return C;
}
function pill(text, val, key, isSel){
  const el=document.createElement('span'); el.className='pill'; if(isSel) el.classList.add('sel');
  el.textContent=text; el.dataset.key=key; el.dataset.val=val;
  el.onclick=()=>{ const set = key.startsWith('org.') ? (key==='org.country'?SELECTED.org.country : key==='org.region'?SELECTED.org.region : SELECTED.org.estate) : (key==='flvL2'?SELECTED.flvL2 : key==='flvL3'?SELECTED.flvL3 : SELECTED[key]);
    if(set.has(val)) set.delete(val); else set.add(val); refreshAll();
  };
  return el;
}
function renderChips(counts){
  const TH=1;
  const ingBox=document.getElementById('ingGroup'); ingBox.innerHTML='';
  [...counts.ing.entries()].filter(([,c])=>c>=TH).forEach(([k,c])=>ingBox.appendChild(pill(getLabel(k), k, 'ing', SELECTED.ing.has(k))));
  const procBox=document.getElementById('procGroup'); procBox.innerHTML='';
  [...counts.proc.entries()].filter(([,c])=>c>=TH).forEach(([k,c])=>procBox.appendChild(pill(getLabel(k), k, 'proc', SELECTED.proc.has(k))));
  const flvBox=document.getElementById('flvGroup'); flvBox.innerHTML='';
  [...counts.flvL2.entries()].filter(([k,c]) => c >= TH && k !== 'flv.fruit' && k !== 'flv.taste' && k !== 'flv.mouthfeel').forEach(([k,c])=>flvBox.appendChild(pill(getLabel(k), k, 'flvL2', SELECTED.flvL2.has(k))));
  const rstBox=document.getElementById('rstGroup'); rstBox.innerHTML='';
  [...counts.rst.entries()].filter(([,c])=>c>=TH).forEach(([k,c])=>rstBox.appendChild(pill(getLabel(k), k, 'rst', SELECTED.rst.has(k))));
  const spcBox=document.getElementById('spcGroup'); spcBox.innerHTML='';
  [...counts.spc.entries()].filter(([,c])=>c>=TH).forEach(([k,c])=>spcBox.appendChild(pill(getLabel(k), k, 'spc', SELECTED.spc.has(k))));
  const oc=document.getElementById('orgCountry'); oc.innerHTML='';
  [...counts.org.country.entries()].filter(([,c])=>c>=TH).forEach(([k,c])=>oc.appendChild(pill(getLabel(last(k)), k, 'org.country', SELECTED.org.country.has(k))));
  const or=document.getElementById('orgRegion'); or.innerHTML='';
  [...counts.org.region.entries()].filter(([,c])=>c>=TH).forEach(([k,c])=>or.appendChild(pill(getLabel(last(k)), k, 'org.region', SELECTED.org.region.has(k))));
  const oe=document.getElementById('orgEstate'); oe.innerHTML='';
  [...counts.org.estate.entries()].filter(([,c])=>c>=TH).forEach(([k,c])=>oe.appendChild(pill(getLabel(last(k)), k, 'org.estate', SELECTED.org.estate.has(k))));
}
const priceMin=document.getElementById('priceMin'); const priceMax=document.getElementById('priceMax');
function syncPrice(){ let a=Math.min(+priceMin.value, +priceMax.value); let b=Math.max(+priceMin.value, +priceMax.value); SELECTED.price=[a,b]; document.getElementById('priceView').textContent=`¥${a} - ¥${b}`; refreshAll(); }
priceMin.oninput=priceMax.oninput=syncPrice;
function renderCards(list, containerId = 'cards'){
  const box=document.getElementById(containerId); box.innerHTML='';
  if(containerId === 'cards') document.getElementById('countHint').textContent=`找到 ${list.length} 款`;
  list.forEach(it=>{
    const tops=(it.flv||[]).slice(0,3).map(t => getLabelZh(t)).join(' · ');
    const procZh = getLabelZh(it.proc);
    const rstZh = getLabelZh(it.rst);
    const meta = [tops, procZh, rstZh].filter(Boolean).join(' · ');
    const d=document.createElement('div');
    d.className='card';
    const badges=[]; const ap=avgPrice(it);
    if(it.spc?.includes('awarded')) badges.push("🏆 获奖/竞标"); if(it.spc?.includes('limited')) badges.push("🎯 限量/独家");
    if(it.spc?.includes('label.red')) badges.push("🔴 红标"); if(it.spc?.includes('harvest.late')) badges.push("🌾 晚收");
    badges.push(ap<=168?"入门价位":ap<=198?"舒适价位":ap<=258?"品质升级":"旗舰价位");
    d.innerHTML=`
      <div class="card-header">
        <h3>${it.name}</h3>
        <div class="like-button">
          <svg class="heart-icon" viewBox="0 0 24 24">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
          </svg>
        </div>
      </div>
      <div class="meta">${meta}</div>
      <div>${badges.map(b=>`<span class="badge">${b}</span>`).join('')}</div>
      <div class="note" style="margin-top:6px; font-weight: 500; color: var(--text-secondary);">¥${it.price[0]}–${it.price[1]} · ${getLabelZh(it.ing[0])}</div>
    `;
    d.querySelector('.like-button').addEventListener('click', (e) => {
        e.currentTarget.querySelector('.heart-icon').classList.toggle('liked');
    });
    box.appendChild(d);
  });
}
/* ====== 3. 各可视化模块渲染函数 ====== */
function arcPath(cx,cy,r,st,en){const x0=cx+r*Math.cos(st),y0=cy+r*Math.sin(st),x1=cx+r*Math.cos(en),y1=cy+r*Math.sin(en);const large=(en-st)>Math.PI?1:0;return `M ${x0} ${y0} A ${r} ${r} 0 ${large} 1 ${x1} ${y1}`;}
function ringSector(cx,cy,r0,r1,st,en){const a0=arcPath(cx,cy,r1,st,en);const x1=cx+r1*Math.cos(en),y1=cy+r1*Math.sin(en);const x2=cx+r0*Math.cos(en),y2=cy+r0*Math.sin(en);const a1=arcPath(cx,cy,r0,en,st);const x3=cx+r1*Math.cos(st),y3=cy+r1*Math.sin(st);return `${a0} L ${x2} ${y2} ${a1} L ${x3} ${y3} Z`;}
function refreshWheel(list){
  const svg=document.getElementById('wheelSvg'); svg.innerHTML='';
  const flvAll=list.flatMap(it=>it.flv||[]); if(!flvAll.length){ svg.innerHTML='<text x="0" y="0" text-anchor="middle" fill="var(--text-muted)" style="font-size:14px">无匹配风味数据，请放宽筛选</text>'; return; }
  const L2=tally(flvAll, t=>prefix(t,2)); const L3byL2={}; L2.forEach(([k])=>{ L3byL2[k]=tally(flvAll.filter(t=>t.startsWith(k+'.')), t=>prefix(t,3)); });
  const cx=0, cy=0, rIn=70, rMid=120, rOut=172; let angle=-Math.PI/2;
  L2.forEach(([k,c],i)=>{
    const frac=c/L2.reduce((s,[_k,cc])=>s+cc,0); const a0=angle, a1=angle+frac*2*Math.PI; angle=a1;
    const hue= (40 + i * 25) % 360; const fillL2=`hsl(${hue} 80% 55% / .65)`, fillL3=`hsl(${hue} 70% 65% / .45)`;
    const p2=document.createElementNS('http://www.w3.org/2000/svg','path'); p2.setAttribute('d', ringSector(cx,cy,rIn,rMid,a0,a1)); p2.setAttribute('fill',fillL2); p2.setAttribute('stroke','var(--bg-end)'); p2.setAttribute('stroke-width','2'); p2.setAttribute('class','wheel-sector'); p2.style.cursor='pointer'; p2.dataset.l2=k; svg.appendChild(p2);
    const mid=(a0+a1)/2, tx=cx+(rIn+rMid)/2*Math.cos(mid), ty=cy+(rIn+rMid)/2*Math.sin(mid); const t2=document.createElementNS('http://www.w3.org/2000/svg','text'); t2.setAttribute('x',tx); t2.setAttribute('y',ty); t2.setAttribute('text-anchor','middle'); t2.setAttribute('dy','.3em'); t2.setAttribute('class','wheel-label'); t2.textContent=getLabelZh(k); svg.appendChild(t2);
    let a=a0; const L3=L3byL2[k]; const sumL3=L3.reduce((s,[_k3,n])=>s+n,0)||1;
    L3.forEach(([k3,n])=>{
      const f=n/sumL3; const b0=a, b1=a+f*(a1-a0); a=b1; const p3=document.createElementNS('http://www.w3.org/2000/svg','path'); p3.setAttribute('d', ringSector(cx,cy,rMid+4,rOut,b0,b1)); p3.setAttribute('fill',fillL3); p3.setAttribute('stroke','var(--bg-end)'); p3.setAttribute('stroke-width','2'); p3.setAttribute('class','wheel-sector'); p3.style.cursor='pointer'; p3.dataset.l3=k3; svg.appendChild(p3);
      if((b1-b0)>0.22){ const m=(b0+b1)/2, tx3=cx+(rOut-12)*Math.cos(m), ty3=cy+(rOut-12)*Math.sin(m); const t3=document.createElementNS('http://www.w3.org/2000/svg','text'); t3.setAttribute('x',tx3); t3.setAttribute('y',ty3); t3.setAttribute('text-anchor','middle'); t3.setAttribute('class','wheel-label l3'); t3.textContent=getLabelZh(k3); svg.appendChild(t3); }
      p3.onclick=()=>{ SELECTED.flvL3.has(k3)?SELECTED.flvL3.delete(k3):SELECTED.flvL3.add(k3); refreshAll(); };
    });
    p2.onclick=()=>{ SELECTED.flvL2.has(k)?SELECTED.flvL2.delete(k):SELECTED.flvL2.add(k); refreshAll(); };
  });
}
let map, layerGroup;
function initMap(){ map = L.map('map',{center:[8.78,-82.5],zoom:9,zoomControl:true}); L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{ attribution:'&copy; CartoDB' }).addTo(map); layerGroup = L.layerGroup().addTo(map); }
function refreshMap(list){
  layerGroup.clearLayers(); const counts=new Map();
  list.forEach(it=>{ const p=it.org.replace(/^org\./,''); let k=p; if(!(k in GEO)) k=p.split('.').slice(0,2).join('.'); if(!(k in GEO)) k=p.split('.')[0]; counts.set(k,(counts.get(k)||0)+1); });
  counts.forEach((c,key)=>{
    const g=GEO[key]; if(!g) return;
    const marker=L.circleMarker([g.lat,g.lon],{ radius: Math.max(5, Math.min(15, 4+Math.sqrt(c*2))), color:'var(--accent)', weight:1.5, fillColor:'var(--accent-hover)', fillOpacity:.5 })
      .bindTooltip(`${getLabelZh(g.label.toLowerCase())} · ${c} 款`, { permanent: false, direction: 'top', sticky: true });
    
    marker.on('click', ()=>{
      SELECTED.org.country.clear(); SELECTED.org.region.clear(); SELECTED.org.estate.clear();
      const seg=key.split('.');
      if(seg.length===3){ SELECTED.org.estate.add(`${seg[0]}.${seg[1]}.${seg[2]}`); }
      else if(seg.length===2){ SELECTED.org.region.add(`${seg[0]}.${seg[1]}`); }
      else { SELECTED.org.country.add(seg[0]); }
      refreshAll();
    });
    layerGroup.addLayer(marker);
  });
}
function renderMouthfeelMatrix(data) {
  const container = document.getElementById('pane-matrix');
  container.innerHTML = `<div class="xy-wrap" id="taste-mouthfeel-matrix"><div class="xy-panel"><h3 class="xy-title">口感矩阵 (Taste × Mouthfeel)</h3><div class="xy-note">基于当前筛选结果动态生成。点击单元格查看命中商品。</div><div class="xy-grid"><table class="xy-table" id="xy-table"></table></div></div><aside class="xy-panel"><h3 class="xy-title">命中商品</h3><div class="xy-note" id="xy-hint">点击矩阵中的任意单元格。</div><div class="xy-list" id="xy-list"></div></aside></div>`;
  if(!data || !data.length){ container.querySelector('#xy-hint').textContent = '无数据显示，请放宽筛选条件。'; return; }
  const X_AXIS = [{key:'sweet', label:'Sugar Sweet'}, {key:'sour', label:'Sour'}]; const Y_AXIS = [{key:'sweetness', label:'Sweetness'}, {key:'mild', label:'Mild'}, {key:'aftertaste', label:'Aftertaste'}, {key:'balanced', label:'Balanced'}];
  function hasAny(tags, reArr){ return (tags||[]).some(t => reArr.some(re=> re.test(t))); }
  function isSweetTaste(it){ return hasAny(it.flv,[/^flv\.taste\.sweet/i, /^flv\.sweet\b/i, /honey|nectar|candy|sugar|cane-juice|fruit-sugar/i]); }
  function isSourTaste(it){ return hasAny(it.flv,[/^flv\.taste\.sour/i, /bright-acidity/i, /^flv\.fruit\.citrus\b/i, /lemon|bergamot|grapefruit|orange/i]); }
  function hasSweetnessMouthfeel(it){ return hasAny(it.flv,[/^flv\.mouthfeel\.sweet/i, /^flv\.sweet\b/i, /honey|nectar|candy|sugar|cane-juice/i]); }
  function hasMildMouthfeel(it){ return hasAny(it.flv,[/^flv\.mouthfeel\.mild/i, /mild|delicate|smooth|rounded/i]); }
  function hasAftertasteMouthfeel(it){ return hasAny(it.flv,[/^flv\.mouthfeel\.lingering/i, /lingering|finish/i, /white-wine-finish|port-wine/i]); }
  function hasBalancedMouthfeel(it){ return hasAny(it.flv,[/^flv\.mouthfeel\.balanced/i, /balanced/i]) || (isSweetTaste(it) && isSourTaste(it)); }
  function tasteFlags(it){ return {sweet: isSweetTaste(it), sour: isSourTaste(it)}; }
  function mouthfeelFlags(it){ return {sweetness: hasSweetnessMouthfeel(it), mild: hasMildMouthfeel(it), aftertaste: hasAftertasteMouthfeel(it), balanced: hasBalancedMouthfeel(it)}; }
  const matrix = {}; Y_AXIS.forEach(y=>{ matrix[y.key]={}; X_AXIS.forEach(x=> matrix[y.key][x.key]=[] ); });
  data.forEach(it=>{ const tx = tasteFlags(it); const my = mouthfeelFlags(it); Y_AXIS.forEach(y=>{ if(!my[y.key]) return; X_AXIS.forEach(x=>{ if(!tx[x.key]) return; matrix[y.key][x.key].push(it); }); }); });
  const T_LABEL = { sweet:'Sugar Sweet', sour:'Sour' }, M_LABEL = { sweetness:'Sweetness', mild:'Mild', aftertaste:'Aftertaste', balanced:'Balanced' };
  const table = container.querySelector('#xy-table'); table.innerHTML = ''; const thead=document.createElement('thead'); const trh=document.createElement('tr');
  trh.innerHTML = `<th class="xy-rowhd">Mouthfeel \\ Taste</th>` + X_AXIS.map(x=>{ const n = data.filter(it=> tasteFlags(it)[x.key]).length; return `<th data-x="${x.key}" title="命中 ${n} 款">${T_LABEL[x.key]} · <span class="xy-chip">${n}</span></th>`; }).join('');
  thead.appendChild(trh); table.appendChild(thead); const tbody=document.createElement('tbody');
  Y_AXIS.forEach(y=>{ const tr=document.createElement('tr'); const nRow = data.filter(it=> mouthfeelFlags(it)[y.key]).length; const th=document.createElement('th'); th.className='xy-rowhd'; th.innerHTML = `<span class="xy-chip">${M_LABEL[y.key]} · ${nRow}</span>`; th.style.cursor='pointer'; th.onclick=()=> showList( data.filter(it=> mouthfeelFlags(it)[y.key]), `${M_LABEL[y.key]}` ); tr.appendChild(th); X_AXIS.forEach(x=>{ const items = matrix[y.key][x.key], n = items.length; const heat = Math.max(0, Math.min(4, Math.floor(n/2))); const td=document.createElement('td'); td.className=`xy-cell xy-heat-${heat}`; td.innerHTML = n ? `<span class="xy-badge">${n}</span>` : `<span class="xy-badge" style="opacity:.35">0</span>`; td.title = `${M_LABEL[y.key]} × ${T_LABEL[x.key]}：${n} 款`; td.onclick = ()=> showList(items, `${M_LABEL[y.key]} × ${T_LABEL[x.key]}`); tr.appendChild(td); }); tbody.appendChild(tr); });
  table.appendChild(tbody); trh.querySelectorAll('th').forEach((th,i)=>{ if(i===0) return; const k=X_AXIS[i-1].key; th.style.cursor='pointer'; th.onclick=()=> showList( data.filter(it=> tasteFlags(it)[k]), `${T_LABEL[k]}` ); });
  const listBox=container.querySelector('#xy-list'), hint=container.querySelector('#xy-hint');
  function showList(items, title){
    hint.textContent = title ? `筛选：${title}` : '筛选结果'; listBox.innerHTML=''; if(!items.length){ listBox.innerHTML='<div class="xy-note">暂无匹配。</div>'; return; }
    items.forEach(it=>{ const tops=(it.flv||[]).slice(0,3).map(t => getLabelZh(t)).join(' · '); const procZh = getLabelZh(it.proc); const rstZh = getLabelZh(it.rst); const meta = [tops, procZh, rstZh].filter(Boolean).join(' · '); const div=document.createElement('div'); div.className='xy-card'; div.innerHTML = `<div>${it.name}</div><div class="xy-meta">${meta}</div>`; listBox.appendChild(div); });
  }
}
const aiState = { q1:null, q2:null, q3:null, q4:null };
function handleAiSelect(e){
  const pill = e.target.closest('.pill'); if(!pill) return;
  const wrap = pill.parentElement; [...wrap.querySelectorAll('.pill')].forEach(p=>p.classList.remove('sel')); pill.classList.add('sel');
  const q = wrap.dataset.q; aiState[q] = pill.dataset.value;
  if(q==='q1') document.getElementById('next1').disabled=false; if(q==='q2') document.getElementById('next2').disabled=false; if(q==='q3') document.getElementById('next3').disabled=false;
}
document.querySelectorAll('#pane-ai .group').forEach(el=>el.addEventListener('click', handleAiSelect));
function showQ(id){ document.querySelectorAll('.q-panel').forEach(q=>q.classList.remove('active')); document.getElementById(id).classList.add('active'); }
document.getElementById('next1').onclick=()=>showQ('q2'); document.getElementById('back2').onclick=()=>showQ('q1');
document.getElementById('next2').onclick=()=>showQ('q3'); document.getElementById('back3').onclick=()=>showQ('q2');
document.getElementById('next3').onclick=()=>showQ('q4'); document.getElementById('back4').onclick=()=>showQ('q3');
function scoreItem(it, pref){
  let s = 0; const FLV_MAP = { floral: (tags)=>tags.some(t=>t.startsWith('flv.floral')), citrus: (tags)=>tags.some(t=>t.includes('citrus')), sweet: (tags)=>tags.some(t=>t.startsWith('flv.sweet')), fermented: (tags)=>tags.some(t=>t.startsWith('flv.fermented')) };
  if(pref.q1 && FLV_MAP[pref.q1] && FLV_MAP[pref.q1](it.flv)) s+=5;
  if(pref.q2 && pref.q2!=='any'){ if(it.org.includes(pref.q2)) s+=3; } else if(pref.q2==='any'){ s+=1; }
  if(pref.q3==='light' && it.rst==='medium') s+=1; if(pref.q3==='medium' && it.rst==='medium') s+=3; if(pref.q3==='special' && it.spc && it.spc.length) s+=3;
  const avg = avgPrice(it); const inBand = (band)=>{ if(band==='low') return avg<=168; if(band==='mid') return avg>168 && avg<=198; if(band==='high') return avg>198 && avg<=258; if(band==='ultra') return avg>=259; };
  if(pref.q4 && inBand(pref.q4)) s+=3; s+=1; s += Math.min(2, Math.floor((it.flv?.length||0)/4)); return s;
}
function genAiCopy(top, pref){ const p1 = pref.q1==='floral'?"花香清新":pref.q1==='citrus'?"果香活泼":pref.q1==='sweet'?"甜润温暖":pref.q1==='fermented'?"微醺醇馥":"清爽顺口"; const p2 = pref.q2==='boquete'?"波奎特产区":pref.q2==='volcan'?"沃肯产区":pref.q2==='chiriqui'?"奇里基产区":"巴拿马风土"; const p3 = pref.q3==='light'?"轻盈浅烘":pref.q3==='medium'?"平衡中焙":pref.q3==='dark'?"浓郁深烘":"限量/获奖批次"; const p4 = pref.q4==='low'?"入门尝鲜":pref.q4==='mid'?"舒适之选":pref.q4==='high'?"品质升级":"旗舰体验"; const name = top?.[0] ? `「${top[0].name}」` : "这几款"; return `今天有点需要放松，我猜你会喜欢 ${p1} + ${p2} 的组合，搭配 ${p3}，预算定位为「${p4}」。不妨从 ${name} 开始~`;}
document.getElementById('see').onclick = ()=>{
  if(!aiState.q1) aiState.q1='citrus'; if(!aiState.q2) aiState.q2='any'; if(!aiState.q3) aiState.q3='medium'; if(!aiState.q4) aiState.q4='mid';
  const scored = ITEMS.map(it=>({it, score:scoreItem(it, aiState)})).sort((a,b)=>b.score-a.score).slice(0,3); const top = scored.map(x=>x.it);
  document.getElementById('recoCopy').textContent = genAiCopy(top, aiState); renderCards(top, 'ai-cards');
  const resultSection = document.getElementById('ai-result');
  resultSection.style.display='block'; resultSection.style.animation = 'fadeIn 0.5s ease-out';
  resultSection.scrollIntoView({behavior:'smooth', block:'nearest'});
};

/* ====== 4. Tab 切换与主刷新流程 ====== */
const tabs=document.getElementById('vizTabs'); const panes=document.querySelectorAll('.pane'); let currentPane = 'ai'; // 默认显示 AI
tabs.addEventListener('click',e=>{
  const b=e.target.closest('button'); if(!b) return;
  [...tabs.querySelectorAll('button')].forEach(x=>x.classList.remove('active')); b.classList.add('active');
  currentPane=b.dataset.pane;
  panes.forEach(p=>p.style.display = p.id === `pane-${currentPane}` ? 'block' : 'none');
  if(currentPane==='map'){ setTimeout(()=> map.invalidateSize(), 50); }
  if(currentPane==='matrix'){ refreshAll(); }
});

function refreshAll(){
  const list = filterItems();
  const filtersActive = areFiltersActive();

  renderCards(list);
  const resultsPanel = document.getElementById('results-panel');
  if (list.length > 0) {
    if (resultsPanel.style.display !== 'block') {
      resultsPanel.style.display = 'block';
      resultsPanel.style.animation = 'fadeIn 0.6s ease-out forwards';
    }
  } else {
    resultsPanel.style.display = 'none';
  }

  // 根据当前Tab和筛选状态决定渲染内容
  if (currentPane === 'wheel') {
    refreshWheel(filtersActive ? list : ITEMS);
  }
  if (currentPane === 'map') {
    refreshMap(filtersActive ? list : ITEMS);
  }
  if (currentPane === 'matrix') {
    refreshMouthfeelMatrix(list);
  }
  
  const counts = buildCounts(ITEMS);
  renderChips(counts);
}

/* ====== 5. 初始化 ====== */
document.addEventListener('DOMContentLoaded', () => {
    initMap();
    syncPrice();
    refreshAll();
});
</script>
</body>
</html>
